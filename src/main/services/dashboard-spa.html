<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KxAI Dashboard</title>
  <style>
    :root {
      --bg: #050508; --surface: #0a0a10; --surface2: #111118; --surface3: #1a1a24;
      --border: rgba(255,255,255,0.06); --border-bright: rgba(255,255,255,0.12);
      --text: #f0f0f5; --text-dim: #8888a0; --text-muted: #555568;
      --accent: #00f0ff; --accent2: #00ff88; --warning: #ffe600; --danger: #ff3355;
      --purple: #b347ff; --pink: #ff00aa;
      --font: 'Inter','Segoe UI',-apple-system,BlinkMacSystemFont,sans-serif;
      --font-mono: 'JetBrains Mono','Fira Code','Consolas',monospace;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: var(--font); background: var(--bg); color: var(--text); }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0,240,255,0.15); border-radius: 2px; }

    .dashboard { display: grid; grid-template-columns: 220px 1fr; grid-template-rows: 56px 1fr; height: 100vh; }
    .topbar {
      grid-column: 1 / -1; background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 20px; gap: 12px;
    }
    .topbar__logo { font-size: 24px; }
    .topbar__title { font-size: 16px; font-weight: 600; letter-spacing: 0.02em; }
    .topbar__status { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-dim); font-family: var(--font-mono); }
    .topbar__dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); box-shadow: 0 0 8px rgba(0,255,136,0.4); }
    .topbar__dot--busy { background: var(--pink); box-shadow: 0 0 8px rgba(255,0,170,0.4); animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.3; } }

    .sidebar {
      background: var(--surface); border-right: 1px solid var(--border); padding: 12px 0;
      overflow-y: auto;
    }
    .sidebar__section { padding: 8px 16px; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; font-family: var(--font-mono); }
    .sidebar__item {
      display: flex; align-items: center; gap: 10px; padding: 8px 16px;
      cursor: pointer; font-size: 13px; color: var(--text-dim); transition: all 0.15s;
      border-left: 2px solid transparent;
    }
    .sidebar__item:hover { background: var(--surface2); color: var(--text); }
    .sidebar__item--active { background: rgba(0,240,255,0.05); color: var(--accent); border-left-color: var(--accent); }
    .sidebar__icon { width: 18px; text-align: center; }

    .main { overflow-y: auto; padding: 20px; }

    .card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      padding: 16px; margin-bottom: 16px; transition: border-color 0.15s;
    }
    .card:hover { border-color: var(--border-bright); }
    .card__title { font-size: 13px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.3px; color: var(--text-dim); }
    .card__title .icon { font-size: 16px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

    .stat { text-align: center; }
    .stat__value { font-size: 28px; font-weight: 700; color: var(--accent); font-family: var(--font-mono); }
    .stat__label { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; font-family: var(--font-mono); }
    .table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .table tr:hover td { background: rgba(0,240,255,0.02); }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
    .badge--green { background: rgba(0,255,136,0.1); color: var(--accent2); }
    .badge--blue { background: rgba(0,240,255,0.1); color: var(--accent); }
    .badge--yellow { background: rgba(255,230,0,0.1); color: var(--warning); }
    .badge--red { background: rgba(255,51,85,0.1); color: var(--danger); }
    .badge--purple { background: rgba(179,71,255,0.1); color: var(--purple); }
    .badge--dim { background: rgba(136,136,160,0.08); color: var(--text-dim); }

    .progress-bar { height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
    .progress-bar__fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--purple)); border-radius: 2px; transition: width 0.3s; box-shadow: 0 0 8px rgba(0,240,255,0.3); }

    .tool-card {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
      padding: 10px 12px; margin-bottom: 6px;
      display: flex; justify-content: space-between; align-items: center;
      transition: border-color 0.15s;
    }
    .tool-card:hover { border-color: var(--border-bright); }
    .tool-card__name { font-weight: 500; font-size: 13px; }
    .tool-card__cat { font-size: 11px; color: var(--text-dim); }

    .shortcut { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 13px; }
    .shortcut__keys { display: flex; gap: 4px; }
    .shortcut__key {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 4px;
      padding: 2px 8px; font-size: 11px; font-family: var(--font-mono); color: var(--text-dim);
    }

    .activity-item { display: flex; gap: 12px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 13px; }
    .activity-item__time { color: var(--text-muted); font-size: 11px; min-width: 50px; font-family: var(--font-mono); }
    .activity-item__action { color: var(--text-dim); }

    .empty { text-align: center; padding: 40px; color: var(--text-muted); }
    .empty__icon { font-size: 40px; margin-bottom: 8px; opacity: 0.6; }

    /* ‚îÄ‚îÄ‚îÄ Graph Visualization ‚îÄ‚îÄ‚îÄ */
    .graph-container { position: relative; width: 100%; height: 400px; background: var(--surface2); border-radius: 8px; overflow: hidden; border: 1px solid var(--border); }
    .graph-node {
      position: absolute; width: 60px; height: 60px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; border: 2px solid var(--border); cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .graph-node:hover { transform: scale(1.15); box-shadow: 0 0 24px rgba(0,240,255,0.3); }
    .graph-node--agent { background: var(--surface); border-color: var(--accent); box-shadow: 0 0 12px rgba(0,240,255,0.2); }
    .graph-node--tool { background: var(--surface); border-color: var(--accent2); box-shadow: 0 0 12px rgba(0,255,136,0.2); }
    .graph-node--cron { background: var(--surface); border-color: var(--warning); box-shadow: 0 0 12px rgba(255,230,0,0.15); }
    .graph-node--rag { background: var(--surface); border-color: var(--purple); box-shadow: 0 0 12px rgba(179,71,255,0.2); }
    .graph-node--system { background: var(--surface); border-color: var(--pink); box-shadow: 0 0 12px rgba(255,0,170,0.2); }
    .graph-node--mcp { background: var(--surface); border-color: #ff8800; box-shadow: 0 0 12px rgba(255,136,0,0.25); }
    .graph-label { position: absolute; top: 65px; font-size: 10px; color: var(--text-dim); white-space: nowrap; text-align: center; width: 80px; left: -10px; }
    svg.graph-lines { position: absolute; inset: 0; pointer-events: none; }
    svg.graph-lines line { stroke: rgba(255,255,255,0.06); stroke-width: 1; opacity: 0.5; }
    svg.graph-lines line.active { stroke: var(--accent); stroke-width: 2; opacity: 0.8; animation: line-pulse 2s infinite; filter: drop-shadow(0 0 4px rgba(0,240,255,0.4)); }
    @keyframes line-pulse { 50% { opacity: 0.3; } }
  </style>
</head>
<body>
<div class="dashboard" id="app">
  <div class="topbar">
    <span class="topbar__logo">ü§ñ</span>
    <span class="topbar__title">KxAI Dashboard</span>
    <div class="topbar__status">
      <span class="topbar__dot" id="statusDot"></span>
      <span id="statusText">Idle</span>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar__section">PrzeglƒÖd</div>
    <div class="sidebar__item sidebar__item--active" data-page="overview">
      <span class="sidebar__icon">üìä</span> PrzeglƒÖd
    </div>
    <div class="sidebar__item" data-page="graph">
      <span class="sidebar__icon">üï∏Ô∏è</span> Graf agenta
    </div>
    <div class="sidebar__section">ZarzƒÖdzanie</div>
    <div class="sidebar__item" data-page="tools">
      <span class="sidebar__icon">üîß</span> Narzƒôdzia
    </div>
    <div class="sidebar__item" data-page="mcp">
      <span class="sidebar__icon">üîå</span> MCP Hub
    </div>
    <div class="sidebar__item" data-page="cron">
      <span class="sidebar__icon">‚è∞</span> Cron Jobs
    </div>
    <div class="sidebar__item" data-page="rag">
      <span class="sidebar__icon">üìö</span> RAG Index
    </div>
    <div class="sidebar__item" data-page="system">
      <span class="sidebar__icon">üíª</span> System
    </div>
    <div class="sidebar__section">Inne</div>
    <div class="sidebar__item" data-page="meeting-prep">
      <span class="sidebar__icon">üîç</span> Meeting Prep
    </div>
    <div class="sidebar__item" data-page="meetings">
      <span class="sidebar__icon">üéôÔ∏è</span> Spotkania
    </div>
    <div class="sidebar__item" data-page="activity">
      <span class="sidebar__icon">üìã</span> Aktywno≈õƒá
    </div>
    <div class="sidebar__item" data-page="shortcuts">
      <span class="sidebar__icon">‚å®Ô∏è</span> Skr√≥ty
    </div>
  </div>

  <div class="main" id="mainContent">
    <div class="empty"><div class="empty__icon">‚è≥</div>≈Åadowanie...</div>
  </div>
</div>

<script>
(function() {
  var $ = function(s, p) { return (p || document).querySelector(s); };
  var $$ = function(s, p) { return Array.from((p || document).querySelectorAll(s)); };
  var API = '';
  var currentPage = 'overview';
  // Expose to window for onclick handlers in dynamically generated HTML
  window._dashNav = function(page) { currentPage = page; loadPage(page); };
  var wsConn = null;
  var agentStatus = { state: 'idle' };
  var liveMeetingState = null;
  var liveTranscript = [];
  var liveCoachingTips = [];

  // WebSocket
  function connectWS() {
    var proto = location.protocol === 'https:' ? 'wss' : 'ws';
    wsConn = new WebSocket(proto + '://' + location.host + '/');
    wsConn.onmessage = function(e) {
      try {
        var msg = JSON.parse(e.data);
        if (msg.type === 'agent:status') {
          agentStatus = msg.data;
          updateStatusIndicator();
          if (currentPage === 'overview' || currentPage === 'graph') loadPage(currentPage);
        }
        // Meeting live events
        if (msg.type === 'meeting:state') {
          liveMeetingState = msg.data;
          if (currentPage === 'meetings' || currentPage === 'meeting-live') {
            loadPage(currentPage);
          }
        }
        if (msg.type === 'meeting:transcript' && msg.data) {
          if (msg.data.line) {
            liveTranscript.push(msg.data.line);
            if (currentPage === 'meeting-live') updateLiveTranscript();
          }
        }
        if (msg.type === 'meeting:coaching-done' && msg.data) {
          liveCoachingTips.push(msg.data);
          if (currentPage === 'meeting-live') updateLiveCoaching();
        }
        if (msg.type === 'meeting:started') {
          liveTranscript = [];
          liveCoachingTips = [];
          liveMeetingState = { active: true };
        }
        if (msg.type === 'meeting:stopped') {
          liveMeetingState = null;
          if (currentPage === 'meeting-live') loadPage('meetings');
        }
        // Meeting prep progress
        if (msg.type === 'meeting-prep:progress' && msg.data) {
          var progEl = document.getElementById('prep-progress');
          if (progEl) {
            progEl.textContent = msg.data.status || '';
          }
        }
      } catch(ex) {}
    };
    wsConn.onclose = function() { setTimeout(connectWS, 3000); };
  }
  connectWS();

  function updateStatusIndicator() {
    var dot = $('#statusDot');
    var txt = $('#statusText');
    var busy = agentStatus.state !== 'idle';
    dot.className = 'topbar__dot' + (busy ? ' topbar__dot--busy' : '');
    var labels = { idle:'Idle', thinking:'My≈õlenie...', 'tool-calling':'Narzƒôdzie: '+(agentStatus.toolName||''), streaming:'Streaming', heartbeat:'Heartbeat', 'take-control':'Sterowanie', 'sub-agent':'Sub-agent' };
    txt.textContent = labels[agentStatus.state] || agentStatus.state;
  }

  // Navigation
  $$('.sidebar__item').forEach(function(item) {
    item.onclick = function() {
      $$('.sidebar__item').forEach(function(i) { i.classList.remove('sidebar__item--active'); });
      item.classList.add('sidebar__item--active');
      currentPage = item.dataset.page;
      loadPage(currentPage);
    };
  });

  function api(path) {
    return fetch(API + path)
      .then(function(r) { return r.json(); })
      .then(function(j) { return j.data; })
      .catch(function() { return null; });
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function loadPage(page) {
    var main = $('#mainContent');
    switch(page) {
      case 'overview': return renderOverview(main);
      case 'graph': return renderGraph(main);
      case 'tools': return renderTools(main);
      case 'mcp': return renderMcpHub(main);
      case 'cron': return renderCron(main);
      case 'rag': return renderRag(main);
      case 'system': return renderSystem(main);
      case 'meetings': return renderMeetings(main);
      case 'meeting-prep': return renderMeetingPrep(main);
      case 'meeting-live': return renderMeetingLive(main);
      case 'activity': return renderActivity(main);
      case 'shortcuts': return renderShortcuts(main);
      default:
        if (page && page.indexOf('meeting/') === 0) {
          return renderMeetingDetail(main, page.replace('meeting/', ''));
        }
    }
  }

  // Handle hash-based routing for meeting details
  function handleHash() {
    var hash = location.hash.replace('#/', '').replace('#', '');
    if (hash.indexOf('meeting/') === 0) {
      currentPage = hash;
      $$('.sidebar__item').forEach(function(i) { i.classList.remove('sidebar__item--active'); });
      $$('.sidebar__item[data-page="meetings"]').forEach(function(i) { i.classList.add('sidebar__item--active'); });
      loadPage(hash);
    } else if (hash === 'meetings') {
      currentPage = 'meetings';
      $$('.sidebar__item').forEach(function(i) { i.classList.remove('sidebar__item--active'); });
      $$('.sidebar__item[data-page="meetings"]').forEach(function(i) { i.classList.add('sidebar__item--active'); });
      loadPage('meetings');
    }
  }
  window.addEventListener('hashchange', handleHash);

  function renderOverview(el) {
    Promise.all([
      api('/api/status'), api('/api/rag'), api('/api/cron'), api('/api/subagents')
    ]).then(function(results) {
      var status = results[0], rag = results[1], cron = results[2], subagents = results[3];
      var ragData = rag || { totalChunks: 0, totalFiles: 0, embeddingType: '-' };
      var cronJobs = cron || [];
      var enabledCron = cronJobs.filter(function(j) { return j.enabled; }).length;
      var activeSubagents = subagents && subagents.active ? subagents.active.length : 0;
      var uptimeH = status ? Math.round(status.uptime / 3600) : 0;
      var memMB = status ? Math.round(status.memory.heapUsed / 1024 / 1024) : 0;

      el.innerHTML =
        '<div class="grid-3">' +
          '<div class="card"><div class="stat"><div class="stat__value">' + ragData.totalFiles + '</div><div class="stat__label">Zaindeksowanych plik√≥w</div></div></div>' +
          '<div class="card"><div class="stat"><div class="stat__value">' + ragData.totalChunks + '</div><div class="stat__label">Fragment√≥w RAG</div></div></div>' +
          '<div class="card"><div class="stat"><div class="stat__value">' + enabledCron + '/' + cronJobs.length + '</div><div class="stat__label">Aktywnych Cron Jobs</div></div></div>' +
        '</div>' +
        '<div class="grid-2">' +
          '<div class="card">' +
            '<div class="card__title"><span class="icon">ü§ñ</span> Status agenta</div>' +
            '<table class="table">' +
              '<tr><td>Stan</td><td><span class="badge badge--' + (agentStatus.state==='idle'?'green':'yellow') + '">' + agentStatus.state + '</span></td></tr>' +
              '<tr><td>Szczeg√≥≈Çy</td><td>' + escapeHtml(agentStatus.detail || '-') + '</td></tr>' +
              '<tr><td>Sub-agenci</td><td>' + activeSubagents + '</td></tr>' +
              '<tr><td>Uptime</td><td>' + uptimeH + 'h</td></tr>' +
              '<tr><td>Pamiƒôƒá</td><td>' + memMB + ' MB</td></tr>' +
            '</table>' +
          '</div>' +
          '<div class="card">' +
            '<div class="card__title"><span class="icon">üìö</span> RAG Index</div>' +
            '<table class="table">' +
              '<tr><td>Pliki</td><td>' + ragData.totalFiles + '</td></tr>' +
              '<tr><td>Fragmenty</td><td>' + ragData.totalChunks + '</td></tr>' +
              '<tr><td>Embeddingi</td><td><span class="badge badge--blue">' + ragData.embeddingType + '</span></td></tr>' +
              '<tr><td>Foldery</td><td>' + (ragData.folders ? ragData.folders.length : 0) + '</td></tr>' +
            '</table>' +
          '</div>' +
        '</div>';
    });
  }

  function renderGraph(el) {
    Promise.all([
      api('/api/subagents'), api('/api/rag'), api('/api/cron'), api('/api/mcp')
    ]).then(function(results) {
      var subagents = results[0], rag = results[1], cron = results[2], mcp = results[3];
      var activeSubagents = subagents && subagents.active ? subagents.active : [];
      var cronJobs = (cron || []).filter(function(j) { return j.enabled; }).slice(0, 5);
      var ragFolders = rag && rag.folders ? rag.folders : [];
      var mcpServers = mcp && mcp.servers ? mcp.servers.filter(function(s) { return s.status === 'connected'; }) : [];

      var cx = 350, cy = 180;
      var nodes = [{ id:'agent', label:'Agent', emoji:'ü§ñ', cls:'agent', x:cx, y:cy }];
      var lines = [];
      var totalItems = activeSubagents.length + cronJobs.length + mcpServers.length + 3;
      var angleStep = (2 * Math.PI) / Math.max(4, totalItems);
      var idx = 0;

      activeSubagents.forEach(function(sa, i) {
        var a = angleStep * idx++; var nx = cx + 140 * Math.cos(a); var ny = cy + 120 * Math.sin(a);
        nodes.push({ id:'sa-'+i, label:(sa.task||'Sub-agent').slice(0,15), emoji:'ü§ñ', cls:'agent', x:nx, y:ny });
        lines.push({ from:'agent', to:'sa-'+i, active: sa.status==='running' });
      });

      var a1 = angleStep * idx++;
      nodes.push({ id:'tools', label:'Narzƒôdzia', emoji:'üîß', cls:'tool', x:cx+140*Math.cos(a1), y:cy+120*Math.sin(a1) });
      lines.push({ from:'agent', to:'tools', active:agentStatus.state==='tool-calling' });

      cronJobs.forEach(function(cj, i) {
        var a = angleStep * idx++; var nx = cx + 140*Math.cos(a); var ny = cy + 120*Math.sin(a);
        nodes.push({ id:'cron-'+i, label:(cj.name||'Cron').slice(0,15), emoji:'‚è∞', cls:'cron', x:nx, y:ny });
        lines.push({ from:'agent', to:'cron-'+i, active:false });
      });

      var a2 = angleStep * idx++;
      nodes.push({ id:'rag', label:'RAG Index', emoji:'üìö', cls:'rag', x:cx+140*Math.cos(a2), y:cy+120*Math.sin(a2) });
      lines.push({ from:'agent', to:'rag', active:false });

      var a3 = angleStep * idx++;
      nodes.push({ id:'sys', label:'System', emoji:'üíª', cls:'system', x:cx+140*Math.cos(a3), y:cy+120*Math.sin(a3) });
      lines.push({ from:'agent', to:'sys', active:false });

      mcpServers.forEach(function(ms, i) {
        var a = angleStep * idx++; var nx = cx + 140*Math.cos(a); var ny = cy + 120*Math.sin(a);
        var icon = ms.icon || 'üîå';
        nodes.push({ id:'mcp-'+i, label:(ms.name||'MCP').slice(0,15), emoji:icon, cls:'mcp', x:nx, y:ny });
        lines.push({ from:'agent', to:'mcp-'+i, active:true });
      });

      var svgLines = lines.map(function(l) {
        var fromN = nodes.find(function(n) { return n.id===l.from; });
        var toN = nodes.find(function(n) { return n.id===l.to; });
        return '<line x1="' + (fromN.x+30) + '" y1="' + (fromN.y+30) + '" x2="' + (toN.x+30) + '" y2="' + (toN.y+30) + '" class="' + (l.active?'active':'') + '"/>';
      }).join('');

      var nodeEls = nodes.map(function(n) {
        return '<div class="graph-node graph-node--' + n.cls + '" style="left:' + n.x + 'px;top:' + n.y + 'px" title="' + n.label + '">' +
          n.emoji +
          '<div class="graph-label">' + n.label + '</div>' +
        '</div>';
      }).join('');

      el.innerHTML =
        '<div class="card">' +
          '<div class="card__title"><span class="icon">üï∏Ô∏è</span> Graf po≈ÇƒÖcze≈Ñ agenta</div>' +
          '<div class="graph-container">' +
            '<svg class="graph-lines" width="100%" height="100%">' + svgLines + '</svg>' +
            nodeEls +
          '</div>' +
        '</div>';
    });
  }

  function renderMcpHub(el) {
    Promise.all([api('/api/mcp'), api('/api/mcp/registry')]).then(function(results) {
      var hub = results[0] || { servers: [], totalTools: 0, connectedCount: 0 };
      var registry = results[1] || [];

      var statusColors = { connected: 'var(--accent2)', connecting: 'var(--warning)', error: 'var(--danger)', disconnected: 'var(--text-muted)' };
      var statusLabels = { connected: 'Po≈ÇƒÖczony', connecting: '≈ÅƒÖczenie...', error: 'B≈ÇƒÖd', disconnected: 'Roz≈ÇƒÖczony' };

      // Connected servers section
      var serversHtml = '';
      if (hub.servers.length > 0) {
        hub.servers.forEach(function(s) {
          var color = statusColors[s.status] || 'var(--text-muted)';
          var label = statusLabels[s.status] || s.status;
          var toolList = s.tools && s.tools.length > 0 ? s.tools.map(function(t) { return t.name; }).join(', ') : 'brak';
          serversHtml += '<div class="tool-card" style="border-left:3px solid ' + color + '">' +
            '<div style="flex:1">' +
              '<div class="tool-card__name">' + (s.icon || 'üîå') + ' ' + escapeHtml(s.name) + '</div>' +
              '<div class="tool-card__cat" style="margin-top:4px">' +
                '<span style="color:' + color + '">' + label + '</span>' +
                (s.tools ? ' ¬∑ ' + s.tools.length + ' tools' : '') +
                (s.callCount ? ' ¬∑ ' + s.callCount + ' calls' : '') +
              '</div>' +
              (s.tools && s.tools.length > 0 ? '<div class="tool-card__cat" style="margin-top:2px;font-size:10px">üîß ' + escapeHtml(toolList) + '</div>' : '') +
              (s.error ? '<div style="color:var(--danger);font-size:11px;margin-top:2px">' + escapeHtml(s.error) + '</div>' : '') +
            '</div>' +
            '<div style="display:flex;gap:6px">' +
              (s.status === 'connected' ?
                '<button class="btn btn--small" onclick="mcpAction(\'disconnect\',\'' + s.id + '\')">Roz≈ÇƒÖcz</button>' :
                '<button class="btn btn--small btn--accent" onclick="mcpAction(\'connect\',\'' + s.id + '\')">Po≈ÇƒÖcz</button>') +
              '<button class="btn btn--small" onclick="mcpAction(\'remove\',\'' + s.id + '\')" style="color:var(--danger)">‚úï</button>' +
            '</div>' +
          '</div>';
        });
      } else {
        serversHtml = '<div style="color:var(--text-dim);padding:12px;font-size:13px">Brak skonfigurowanych serwer√≥w MCP. Dodaj serwer z rejestru poni≈ºej.</div>';
      }

      // Registry section
      var registryHtml = '';
      registry.forEach(function(r) {
        var isAdded = hub.servers.some(function(s) { return s.name === r.name; });
        registryHtml += '<div class="tool-card">' +
          '<div style="flex:1">' +
            '<div class="tool-card__name">' + (r.icon || 'üîå') + ' ' + escapeHtml(r.name) +
              (r.category ? ' <span class="badge badge--blue">' + escapeHtml(r.category) + '</span>' : '') +
            '</div>' +
            '<div class="tool-card__cat" style="margin-top:4px">' + escapeHtml(r.description || '') + '</div>' +
            (r.requiresSetup ? '<div style="color:var(--warning);font-size:10px;margin-top:2px">‚ö†Ô∏è Wymaga konfiguracji (API key / env vars)</div>' : '') +
          '</div>' +
          '<div style="display:flex;gap:6px;align-items:center">' +
            (r.docsUrl ? '<a href="' + r.docsUrl + '" target="_blank" class="btn btn--small">üìñ Docs</a>' : '') +
            (isAdded ?
              '<span style="color:var(--accent2);font-size:12px">‚úì Dodany</span>' :
              '<button class="btn btn--small btn--accent" onclick="mcpAddFromRegistry(\'' + r.id + '\')">+ Dodaj</button>') +
          '</div>' +
        '</div>';
      });

      el.innerHTML =
        '<div class="card">' +
          '<div class="card__title"><span class="icon">üîå</span> MCP Hub' +
            '<span style="margin-left:auto;font-size:12px;color:var(--text-dim)">' +
              hub.connectedCount + ' po≈ÇƒÖczonych ¬∑ ' + hub.totalTools + ' narzƒôdzi' +
            '</span>' +
          '</div>' +
          serversHtml +
        '</div>' +
        '<div class="card" style="margin-top:16px">' +
          '<div class="card__title"><span class="icon">üì¶</span> Rejestr serwer√≥w MCP (' + registry.length + ')</div>' +
          '<div style="color:var(--text-dim);font-size:12px;margin-bottom:12px">Popularne serwery MCP ‚Äî kliknij "Dodaj" aby pod≈ÇƒÖczyƒá do agenta.</div>' +
          registryHtml +
        '</div>';
    });
  }

  // MCP actions (called from inline onclick)
  window.mcpAction = function(action, id) {
    var endpoint = '/api/mcp/' + action;
    fetch(API + endpoint, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({id:id}) })
      .then(function() { loadPage('mcp'); })
      .catch(function(e) { alert('B≈ÇƒÖd: ' + e.message); });
  };

  window.mcpAddFromRegistry = function(registryId) {
    fetch(API + '/api/mcp/add-from-registry', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({registryId:registryId}) })
      .then(function() { loadPage('mcp'); })
      .catch(function(e) { alert('B≈ÇƒÖd: ' + e.message); });
  };

  function renderTools(el) {
    api('/api/tools').then(function(tools) {
      tools = tools || [];
      var cats = {};
      tools.forEach(function(t) { (cats[t.category] = cats[t.category] || []).push(t); });

      var html = '<div class="card"><div class="card__title"><span class="icon">üîß</span> Dostƒôpne narzƒôdzia (' + tools.length + ')</div>';
      Object.keys(cats).forEach(function(cat) {
        html += '<h4 style="margin:12px 0 6px;color:var(--text-dim);font-size:12px;text-transform:uppercase">' + cat + '</h4>';
        cats[cat].forEach(function(t) {
          var paramCount = t.parameters ? Object.keys(t.parameters).length : 0;
          html += '<div class="tool-card"><div><div class="tool-card__name">' + t.name + '</div><div class="tool-card__cat">' + t.description + '</div></div><span class="badge badge--blue">' + paramCount + ' params</span></div>';
        });
      });
      html += '</div>';
      el.innerHTML = html;
    });
  }

  function renderCron(el) {
    api('/api/cron').then(function(jobs) {
      jobs = jobs || [];
      var rows = jobs.map(function(j) {
        var safeName = escapeHtml(String(j.name || ''));
        var safeSchedule = escapeHtml(String(j.schedule || ''));
        var safeCategory = escapeHtml(String(j.category || ''));
        var safeRunCount = String(Number(j.runCount) || 0);
        var safeEnabled = !!j.enabled;
        var safeLastRun = j.lastRun ? escapeHtml(new Date(j.lastRun).toLocaleString('pl')) : '-';
        return '<tr>' +
          '<td>' + safeName + '</td>' +
          '<td><code>' + safeSchedule + '</code></td>' +
          '<td><span class="badge badge--purple">' + safeCategory + '</span></td>' +
          '<td><span class="badge badge--' + (safeEnabled?'green':'red') + '">' + (safeEnabled?'Aktywny':'Wy≈ÇƒÖczony') + '</span></td>' +
          '<td>' + safeRunCount + '</td>' +
          '<td>' + safeLastRun + '</td>' +
        '</tr>';
      }).join('');
      el.innerHTML =
        '<div class="card"><div class="card__title"><span class="icon">‚è∞</span> Cron Jobs (' + jobs.length + ')</div>' +
        '<table class="table"><thead><tr><th>Nazwa</th><th>Harmonogram</th><th>Kategoria</th><th>Status</th><th>Uruchomie≈Ñ</th><th>Ostatnio</th></tr></thead><tbody>' +
        rows + '</tbody></table></div>';
    });
  }

  function renderRag(el) {
    api('/api/rag').then(function(rag) {
      if (!rag) { el.innerHTML = '<div class="empty"><div class="empty__icon">üìö</div>RAG nie jest skonfigurowany</div>'; return; }
      var folderRows = (rag.folders || []).map(function(f) {
        return '<tr><td>' + f.path + '</td><td>' + f.fileCount + '</td><td>' + f.chunkCount + '</td><td>' + (f.lastIndexed ? new Date(f.lastIndexed).toLocaleString('pl') : '-') + '</td></tr>';
      }).join('');
      el.innerHTML =
        '<div class="grid-3">' +
          '<div class="card"><div class="stat"><div class="stat__value">' + rag.totalFiles + '</div><div class="stat__label">Plik√≥w</div></div></div>' +
          '<div class="card"><div class="stat"><div class="stat__value">' + rag.totalChunks + '</div><div class="stat__label">Fragment√≥w</div></div></div>' +
          '<div class="card"><div class="stat"><div class="stat__value badge badge--blue">' + rag.embeddingType + '</div><div class="stat__label">Typ embedding√≥w</div></div></div>' +
        '</div>' +
        '<div class="card"><div class="card__title"><span class="icon">üìÅ</span> Zaindeksowane foldery</div>' +
        '<table class="table"><thead><tr><th>≈öcie≈ºka</th><th>Pliki</th><th>Fragmenty</th><th>Ostatnie indeksowanie</th></tr></thead><tbody>' +
        folderRows + '</tbody></table></div>';
    });
  }

  function renderSystem(el) {
    api('/api/system').then(function(sys) {
      if (!sys) { el.innerHTML = '<div class="empty"><div class="empty__icon">üíª</div>System monitor niedostƒôpny</div>'; return; }
      var batteryHtml = sys.battery
        ? '<div class="stat"><div class="stat__value">' + sys.battery.percent + '%</div><div class="stat__label">' + (sys.battery.charging?'≈Åadowanie':'Na baterii') + ' ¬∑ ' + sys.battery.timeRemaining + '</div></div>'
        : '<div class="stat"><div class="stat__label">Brak baterii</div></div>';
      el.innerHTML =
        '<div class="grid-3">' +
          '<div class="card"><div class="card__title"><span class="icon">üñ•Ô∏è</span> CPU</div>' +
            '<div class="stat"><div class="stat__value">' + Math.round(sys.cpu.usagePercent) + '%</div><div class="stat__label">' + sys.cpu.model + ' ¬∑ ' + sys.cpu.cores + ' rdzeni</div></div>' +
            '<div class="progress-bar" style="margin-top:8px"><div class="progress-bar__fill" style="width:' + sys.cpu.usagePercent + '%"></div></div></div>' +
          '<div class="card"><div class="card__title"><span class="icon">üíæ</span> RAM</div>' +
            '<div class="stat"><div class="stat__value">' + sys.memory.usedGB.toFixed(1) + ' / ' + sys.memory.totalGB.toFixed(1) + ' GB</div><div class="stat__label">' + Math.round(sys.memory.usagePercent) + '% u≈ºycia</div></div>' +
            '<div class="progress-bar" style="margin-top:8px"><div class="progress-bar__fill" style="width:' + sys.memory.usagePercent + '%"></div></div></div>' +
          '<div class="card"><div class="card__title"><span class="icon">üîã</span> Bateria</div>' + batteryHtml + '</div>' +
        '</div>' +
        '<div class="card"><div class="card__title"><span class="icon">üì°</span> System</div>' +
        '<table class="table">' +
          '<tr><td>Host</td><td>' + sys.system.hostname + '</td></tr>' +
          '<tr><td>OS</td><td>' + sys.system.platform + ' ' + sys.system.arch + ' ¬∑ ' + sys.system.osVersion + '</td></tr>' +
          '<tr><td>Uptime</td><td>' + sys.system.uptimeHours.toFixed(1) + 'h</td></tr>' +
          '<tr><td>Node</td><td>' + sys.system.nodeVersion + '</td></tr>' +
          '<tr><td>Electron</td><td>' + sys.system.electronVersion + '</td></tr>' +
          '<tr><td>Sieƒá</td><td>' + (sys.network.connected ? '‚úÖ Po≈ÇƒÖczono' : '‚ùå Brak sieci') + '</td></tr>' +
        '</table></div>';
    });
  }

  // ‚îÄ‚îÄ‚îÄ Meeting Prep ‚Äî Participant Research ‚îÄ‚îÄ‚îÄ
  var prepResults = [];

  function renderMeetingPrep(el) {
    var html = '<div class="card">' +
      '<div class="card__title"><span class="icon">üîç</span> Meeting Prep ‚Äî Research uczestnik√≥w</div>' +
      '<p style="color:var(--text-dim);font-size:13px;margin-bottom:16px">Podaj uczestnik√≥w spotkania. AI wyszuka o nich wszystkie dostƒôpne informacje (LinkedIn, Twitter, firma, publikacje).</p>' +
      '<div id="prep-participants">' +
        renderPrepParticipantRow(0) +
      '</div>' +
      '<div style="display:flex;gap:8px;margin-top:12px">' +
        '<button id="btn-add-participant" onclick="addPrepParticipant()" style="background:rgba(0,240,255,0.08);color:var(--accent);border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:12px;font-family:var(--font-mono)">+ Dodaj uczestnika</button>' +
        '<button id="btn-research" onclick="startPrepResearch()" style="background:rgba(0,240,255,0.15);color:var(--accent);border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-size:13px;font-family:var(--font-mono);font-weight:600">üîç Zbadaj wszystkich</button>' +
      '</div>' +
      '<div id="prep-progress" style="color:var(--text-dim);font-size:12px;margin-top:8px;font-style:italic"></div>' +
    '</div>';

    // Show previous results
    if (prepResults.length > 0) {
      html += renderPrepResults(prepResults);
    }

    el.innerHTML = html;
  }

  function renderPrepParticipantRow(idx) {
    return '<div class="prep-row" data-idx="' + idx + '" style="display:flex;gap:8px;margin-bottom:8px;align-items:flex-start">' +
      '<div style="flex:1">' +
        '<input type="text" placeholder="Imiƒô i nazwisko *" class="prep-name" style="width:100%;padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:13px;margin-bottom:4px" />' +
        '<div style="display:flex;gap:6px">' +
          '<input type="text" placeholder="Firma" class="prep-company" style="flex:1;padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px" />' +
          '<input type="text" placeholder="Rola (np. CTO)" class="prep-role" style="flex:1;padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px" />' +
        '</div>' +
      '</div>' +
      '<div style="display:flex;flex-direction:column;align-items:center;gap:4px">' +
        '<label style="width:64px;height:64px;border:2px dashed var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;background:rgba(255,255,255,0.02);overflow:hidden" title="Dodaj zdjƒôcie">' +
          '<input type="file" accept="image/*" class="prep-photo" style="display:none" onchange="handlePrepPhoto(this,' + idx + ')" />' +
          '<span class="prep-photo-preview" data-idx="' + idx + '">üì∑</span>' +
        '</label>' +
        '<span style="font-size:10px;color:var(--text-muted)">Zdjƒôcie</span>' +
      '</div>' +
      '<button onclick="removePrepParticipant(this)" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;padding:4px;margin-top:4px" title="Usu≈Ñ">‚úï</button>' +
    '</div>';
  }

  window.addPrepParticipant = function() {
    var container = document.getElementById('prep-participants');
    if (!container) return;
    var rows = container.querySelectorAll('.prep-row');
    var idx = rows.length;
    container.insertAdjacentHTML('beforeend', renderPrepParticipantRow(idx));
  };

  window.removePrepParticipant = function(btn) {
    var row = btn.closest('.prep-row');
    if (row) row.remove();
  };

  window.handlePrepPhoto = function(input, idx) {
    if (!input.files || !input.files[0]) return;
    var reader = new FileReader();
    reader.onload = function(e) {
      var preview = document.querySelector('.prep-photo-preview[data-idx="' + idx + '"]');
      if (preview) {
        preview.innerHTML = '<img src="' + e.target.result + '" style="width:60px;height:60px;object-fit:cover;border-radius:6px" />';
        preview.setAttribute('data-base64', e.target.result);
      }
    };
    reader.readAsDataURL(input.files[0]);
  };

  window.startPrepResearch = function() {
    var rows = document.querySelectorAll('.prep-row');
    var participants = [];
    rows.forEach(function(row) {
      var name = row.querySelector('.prep-name');
      var company = row.querySelector('.prep-company');
      var role = row.querySelector('.prep-role');
      var preview = row.querySelector('.prep-photo-preview');
      if (name && name.value.trim()) {
        var p = { name: name.value.trim() };
        if (company && company.value.trim()) p.company = company.value.trim();
        if (role && role.value.trim()) p.role = role.value.trim();
        if (preview && preview.getAttribute('data-base64')) p.photoBase64 = preview.getAttribute('data-base64');
        participants.push(p);
      }
    });

    if (participants.length === 0) {
      document.getElementById('prep-progress').textContent = '‚ö†Ô∏è Podaj przynajmniej jednego uczestnika';
      return;
    }

    var btn = document.getElementById('btn-research');
    btn.disabled = true;
    btn.textContent = '‚è≥ Badanie w toku...';
    document.getElementById('prep-progress').textContent = 'Rozpoczynam research...';

    fetch(API + '/api/meeting-prep/research', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ participants: participants }),
    })
    .then(function(r) { return r.json(); })
    .then(function(j) {
      btn.disabled = false;
      btn.textContent = 'üîç Zbadaj wszystkich';
      if (j.success && j.data) {
        prepResults = j.data;
        var main = document.getElementById('mainContent');
        // Re-render with results
        var existingResults = document.getElementById('prep-results-container');
        if (existingResults) existingResults.remove();
        main.insertAdjacentHTML('beforeend', renderPrepResults(j.data));
        document.getElementById('prep-progress').textContent = '‚úÖ Research zako≈Ñczony ‚Äî ' + j.data.length + ' os√≥b zbadanych';
      } else {
        document.getElementById('prep-progress').textContent = '‚ùå B≈ÇƒÖd: ' + (j.error || 'Nieznany b≈ÇƒÖd');
      }
    })
    .catch(function(err) {
      btn.disabled = false;
      btn.textContent = 'üîç Zbadaj wszystkich';
      document.getElementById('prep-progress').textContent = '‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + err.message;
    });
  };

  function renderPrepResults(results) {
    if (!results || results.length === 0) return '';
    var cards = results.map(function(r) {
      var socialLinks = (r.socialMedia || []).map(function(s) {
        return '<a href="' + escapeHtml(s.url) + '" target="_blank" style="color:var(--accent);text-decoration:none;font-size:12px">' + escapeHtml(s.platform) + '</a>';
      }).join(' ¬∑ ');

      var experienceList = (r.experience || []).map(function(e) { return '<li>' + escapeHtml(e) + '</li>'; }).join('');
      var interestsList = (r.interests || []).map(function(i) { return '<span class="badge" style="margin:2px">' + escapeHtml(i) + '</span>'; }).join('');
      var talkingList = (r.talkingPoints || []).map(function(t) { return '<li style="color:var(--accent2)">' + escapeHtml(t) + '</li>'; }).join('');
      var cautionsList = (r.cautions || []).map(function(c) { return '<li style="color:var(--pink)">' + escapeHtml(c) + '</li>'; }).join('');
      var commonList = (r.commonGround || []).map(function(c) { return '<li>' + escapeHtml(c) + '</li>'; }).join('');

      return '<div class="card" style="margin-bottom:12px">' +
        '<div class="card__title">' +
          '<span class="icon">üë§</span> ' + escapeHtml(r.name) +
          (r.role ? ' ¬∑ <span style="color:var(--text-dim);font-weight:400">' + escapeHtml(r.role) + '</span>' : '') +
          (r.company ? ' @ <span style="color:var(--accent)">' + escapeHtml(r.company) + '</span>' : '') +
        '</div>' +
        (r.photoDescription ? '<p style="font-size:12px;color:var(--text-muted);font-style:italic;margin-bottom:8px">üì∑ ' + escapeHtml(r.photoDescription) + '</p>' : '') +
        '<p style="font-size:13px;margin-bottom:12px">' + escapeHtml(r.summary) + '</p>' +
        (socialLinks ? '<div style="margin-bottom:12px">' + socialLinks + '</div>' : '') +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
          (experienceList ? '<div><strong style="font-size:11px;color:var(--text-muted);text-transform:uppercase">Do≈õwiadczenie</strong><ul style="margin:4px 0;padding-left:16px;font-size:12px">' + experienceList + '</ul></div>' : '') +
          (interestsList ? '<div><strong style="font-size:11px;color:var(--text-muted);text-transform:uppercase">Zainteresowania</strong><div style="margin-top:4px">' + interestsList + '</div></div>' : '') +
          (talkingList ? '<div><strong style="font-size:11px;color:var(--text-muted);text-transform:uppercase">üí¨ O czym rozmawiaƒá</strong><ul style="margin:4px 0;padding-left:16px;font-size:12px">' + talkingList + '</ul></div>' : '') +
          (commonList ? '<div><strong style="font-size:11px;color:var(--text-muted);text-transform:uppercase">ü§ù Wsp√≥lne punkty</strong><ul style="margin:4px 0;padding-left:16px;font-size:12px">' + commonList + '</ul></div>' : '') +
        '</div>' +
        (cautionsList ? '<div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px"><strong style="font-size:11px;color:var(--pink);text-transform:uppercase">‚ö†Ô∏è Na co uwa≈ºaƒá</strong><ul style="margin:4px 0;padding-left:16px;font-size:12px">' + cautionsList + '</ul></div>' : '') +
        (r.sources && r.sources.length ? '<div style="margin-top:8px;font-size:10px;color:var(--text-muted)">≈πr√≥d≈Ça: ' + r.sources.map(function(s) { return '<a href="' + escapeHtml(s) + '" target="_blank" style="color:var(--text-muted)">' + escapeHtml(s.slice(0,50)) + '</a>'; }).join(', ') + '</div>' : '') +
      '</div>';
    }).join('');

    return '<div id="prep-results-container"><div class="card__title" style="margin-top:16px;margin-bottom:8px"><span class="icon">üìã</span> Wyniki researchu (' + results.length + ' os√≥b)</div>' + cards + '</div>';
  }

  function renderMeetings(el) {
    api('/api/meetings').then(function(meetings) {
      meetings = meetings || [];

      // Live meeting banner
      var liveBanner = '';
      if (liveMeetingState && liveMeetingState.active) {
        liveBanner =
          '<div class="card" style="border-color:var(--pink);background:rgba(255,0,170,0.03)">' +
            '<div class="card__title"><span class="icon" style="animation:blink 1s infinite">üî¥</span> Spotkanie w toku</div>' +
            '<div style="display:flex;justify-content:space-between;align-items:center">' +
              '<div style="font-size:13px;color:var(--text-dim)">' +
                'üí¨ ' + (liveMeetingState.transcriptLineCount || liveTranscript.length) + ' linii transkrypcji ¬∑ ' +
                'üí° ' + liveCoachingTips.length + ' sugestii' +
              '</div>' +
              '<button onclick="_dashNav(\'meeting-live\')" style="background:rgba(0,240,255,0.08);color:var(--accent);border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;font-family:var(--font-mono)">üì° PodglƒÖd live ‚Üí</button>' +
            '</div>' +
          '</div>';
      }

      if (!meetings.length && !liveBanner) {
        el.innerHTML = '<div class="empty"><div class="empty__icon">üéôÔ∏è</div>Brak spotka≈Ñ</div>';
        return;
      }

      var rows = meetings.map(function(m) {
        var durationStr = m.duration + ' min';
        var participantCount = m.participants ? m.participants.length : 0;
        var dateStr = new Date(m.startTime).toLocaleDateString('pl', { day: '2-digit', month: '2-digit', year: 'numeric' });
        var timeStr = new Date(m.startTime).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit' });
        var hasSummary = m.summary && m.summary.length > 10;
        return '<tr style="cursor:pointer" onclick="_dashNav(\'meeting/' + m.id + '\')">'  +
          '<td><strong style="color:var(--accent)">' + escapeHtml(m.title) + '</strong></td>' +
          '<td>' + dateStr + ' ' + timeStr + '</td>' +
          '<td>' + durationStr + '</td>' +
          '<td>' + participantCount + '</td>' +
          '<td>' + (hasSummary ? '<span class="badge badge--green">‚úì</span>' : '<span class="badge badge--yellow">‚Äî</span>') + '</td>' +
        '</tr>';
      }).join('');

      el.innerHTML = liveBanner +
        '<div class="card"><div class="card__title"><span class="icon">üéôÔ∏è</span> Spotkania (' + meetings.length + ')</div>' +
        '<table class="table"><thead><tr><th>Tytu≈Ç</th><th>Data</th><th>Czas trwania</th><th>Uczestnicy</th><th>Podsumowanie</th></tr></thead><tbody>' +
        rows + '</tbody></table></div>';
    });
  }

  function renderMeetingDetail(el, meetingId) {
    api('/api/meeting/' + meetingId).then(function(m) {
      if (!m) {
        el.innerHTML = '<div class="empty"><div class="empty__icon">‚ùå</div>Nie znaleziono spotkania</div>';
        return;
      }

      var dateStr = new Date(m.startTime).toLocaleDateString('pl', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      var timeStart = new Date(m.startTime).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit' });
      var timeEnd = new Date(m.endTime).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit' });

      // Header
      var html = '<div style="margin-bottom:8px"><button onclick="_dashNav(\'meetings\')" style="background:transparent;color:var(--accent);border:none;cursor:pointer;font-size:13px;padding:4px 0">‚Üê Powr√≥t do listy</button></div>';

      html += '<div class="card" style="border-color:var(--accent)">' +
        '<div style="display:flex;justify-content:space-between;align-items:flex-start">' +
          '<div>' +
            '<h2 style="margin:0 0 4px;font-size:18px;color:var(--text)">' + escapeHtml(m.title) + '</h2>' +
            '<div style="font-size:13px;color:var(--text-dim)">' +
              'üìÖ ' + dateStr + ' ¬∑ ' + timeStart + ' ‚Äì ' + timeEnd + ' ¬∑ ‚è± ' + m.duration + ' min' +
            '</div>' +
          '</div>' +
          (m.detectedApp ? '<span class="badge badge--blue">' + escapeHtml(m.detectedApp) + '</span>' : '') +
          (m.diarized ? '<span class="badge badge--green">‚úì Diaryzacja</span>' : '<span class="badge badge--dim">‚è≥ Bez diaryzacji</span>') +
        '</div>' +
      '</div>';

      // Sentiment
      if (m.sentiment) {
        html += '<div class="card" style="border-left:3px solid var(--purple)">' +
          '<div class="card__title"><span class="icon">üé≠</span> Atmosfera spotkania</div>' +
          '<p style="font-size:14px;line-height:1.6;color:var(--text);margin:0;font-style:italic">' + escapeHtml(m.sentiment) + '</p>' +
        '</div>';
      }

      // Summary
      if (m.summary) {
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üìù</span> Podsumowanie</div>' +
          '<p style="font-size:14px;line-height:1.7;color:var(--text);margin:0">' + escapeHtml(m.summary) + '</p>' +
        '</div>';
      }

      // Stats row
      html += '<div class="grid-3">' +
        '<div class="card"><div class="stat"><div class="stat__value">' + (m.participants ? m.participants.length : 0) + '</div><div class="stat__label">Uczestnik√≥w</div></div></div>' +
        '<div class="card"><div class="stat"><div class="stat__value">' + (m.transcript ? m.transcript.length : 0) + '</div><div class="stat__label">Linii transkrypcji</div></div></div>' +
        '<div class="card"><div class="stat"><div class="stat__value">' + (m.coachingTips ? m.coachingTips.length : 0) + '</div><div class="stat__label">Sugestii coachinga</div></div></div>' +
      '</div>';

      // Key Points & Action Items
      var hasKeyPoints = m.keyPoints && m.keyPoints.length > 0;
      var hasActionItems = m.actionItems && m.actionItems.length > 0;
      if (hasKeyPoints || hasActionItems) {
        html += '<div class="grid-2">';
        if (hasKeyPoints) {
          html += '<div class="card">' +
            '<div class="card__title"><span class="icon">üéØ</span> Kluczowe punkty</div>' +
            '<ul style="margin:0;padding-left:20px;font-size:13px;line-height:1.8;color:var(--text)">' +
            m.keyPoints.map(function(p) { return '<li>' + escapeHtml(p) + '</li>'; }).join('') +
            '</ul></div>';
        }
        if (hasActionItems) {
          html += '<div class="card">' +
            '<div class="card__title"><span class="icon">‚úÖ</span> Dzia≈Çania do podjƒôcia</div>' +
            '<ul style="margin:0;padding-left:20px;font-size:13px;line-height:1.8;color:var(--text)">' +
            m.actionItems.map(function(a) { return '<li>' + escapeHtml(a) + '</li>'; }).join('') +
            '</ul></div>';
        }
        html += '</div>';
      }

      // Participants
      if (m.speakers && m.speakers.length > 0) {
        var participantCards = m.speakers.map(function(s) {
          var isMe = s.name === 'Ja';
          var color = isMe ? 'var(--accent2)' : 'var(--purple)';
          return '<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface2);border-radius:8px">' +
            '<div style="width:36px;height:36px;border-radius:50%;background:' + (isMe ? 'rgba(0,255,136,0.12)' : 'rgba(179,71,255,0.12)') + ';display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">' +
              (isMe ? 'üë§' : 'üéôÔ∏è') +
            '</div>' +
            '<div style="flex:1;min-width:0">' +
              '<div style="font-size:13px;font-weight:600;color:' + color + '">' + escapeHtml(s.name) + '</div>' +
              '<div style="font-size:11px;color:var(--text-muted)">' + s.utteranceCount + ' wypowiedzi' + (s.isAutoDetected ? ' ¬∑ auto-detected' : '') + '</div>' +
            '</div>' +
          '</div>';
        }).join('');
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üë•</span> Uczestnicy</div>' +
          '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">' + participantCards + '</div>' +
        '</div>';
      }

      // Coaching Tips
      if (m.coachingTips && m.coachingTips.length > 0) {
        var tipItems = m.coachingTips.map(function(tip) {
          var catEmoji = { answer: 'üí¨', communication: 'üó£Ô∏è', technical: '‚öôÔ∏è', strategy: '‚ôüÔ∏è' };
          var catColor = { answer: 'var(--accent)', communication: 'var(--accent2)', technical: 'var(--warning)', strategy: 'var(--purple)' };
          var emoji = catEmoji[tip.category] || 'üí°';
          var color = catColor[tip.category] || 'var(--text-dim)';
          var time = new Date(tip.timestamp).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          return '<div style="padding:10px 12px;background:var(--surface2);border-radius:8px;margin-bottom:6px;border-left:3px solid ' + color + '">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:4px">' +
              '<span style="font-size:12px;color:' + color + ';font-weight:600">' + emoji + ' ' + (tip.category || 'tip') + '</span>' +
              '<span style="font-size:11px;color:var(--text-muted)">' + time + '</span>' +
            '</div>' +
            (tip.questionText ? '<div style="font-size:11px;color:var(--text-dim);font-style:italic;margin-bottom:4px">‚ùì ' + escapeHtml(tip.questionText) + '</div>' : '') +
            '<div style="font-size:13px;color:var(--text);line-height:1.5">' + escapeHtml(tip.tip) + '</div>' +
          '</div>';
        }).join('');
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üí°</span> Sugestie coachinga (' + m.coachingTips.length + ')</div>' +
          tipItems +
        '</div>';
      }

      // Transcript
      if (m.transcript && m.transcript.length > 0) {
        var transcriptLines = m.transcript.map(function(line) {
          var time = new Date(line.timestamp).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          var isMe = line.speaker === 'Ja';
          var color = isMe ? 'var(--accent2)' : 'var(--purple)';
          return '<div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--surface2);font-size:12px">' +
            '<span style="color:var(--text-muted);flex-shrink:0;min-width:60px">' + time + '</span>' +
            '<span style="color:' + color + ';font-weight:600;flex-shrink:0;min-width:80px">' + escapeHtml(line.speaker) + '</span>' +
            '<span style="color:var(--text)">' + escapeHtml(line.text) + '</span>' +
          '</div>';
        }).join('');
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üìú</span> Pe≈Çna transkrypcja (' + m.transcript.length + ' linii)</div>' +
          '<div style="max-height:500px;overflow-y:auto">' + transcriptLines + '</div>' +
        '</div>';
      }

      // Briefing
      if (m.briefing && m.briefing.topic) {
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üìã</span> Briefing pre-meeting</div>' +
          '<table class="table">' +
            '<tr><td style="width:120px">Temat</td><td>' + escapeHtml(m.briefing.topic) + '</td></tr>' +
            (m.briefing.agenda ? '<tr><td>Agenda</td><td>' + escapeHtml(m.briefing.agenda) + '</td></tr>' : '') +
            (m.briefing.notes ? '<tr><td>Notatki</td><td>' + escapeHtml(m.briefing.notes) + '</td></tr>' : '') +
            (m.briefing.participants && m.briefing.participants.length > 0 ?
              '<tr><td>Uczestnicy</td><td>' + m.briefing.participants.map(function(p) { return escapeHtml(p.name) + (p.role ? ' (' + escapeHtml(p.role) + ')' : ''); }).join(', ') + '</td></tr>' : '') +
          '</table>' +
        '</div>';
      }

      el.innerHTML = html;
    });
  }

  function renderMeetingLive(el) {
    if (!liveMeetingState || !liveMeetingState.active) {
      el.innerHTML = '<div class="empty"><div class="empty__icon">üéôÔ∏è</div>Brak aktywnego spotkania<br><button onclick="_dashNav(\'meetings\')" style="margin-top:12px;background:rgba(0,240,255,0.08);color:var(--accent);border:none;border-radius:6px;padding:8px 16px;cursor:pointer;font-family:var(--font-mono)">‚Üê Powr√≥t do spotka≈Ñ</button></div>';
      return;
    }

    var html = '<div style="margin-bottom:8px"><button onclick="_dashNav(\'meetings\')" style="background:transparent;color:var(--accent);border:none;cursor:pointer;font-size:13px;padding:4px 0">‚Üê Powr√≥t do listy</button></div>';

    // Live status
    html += '<div class="card" style="border-color:var(--pink)">' +
      '<div style="display:flex;align-items:center;gap:10px">' +
        '<span style="width:10px;height:10px;border-radius:50%;background:var(--pink);box-shadow:0 0 8px rgba(255,0,170,0.5);animation:blink 1s infinite"></span>' +
        '<span style="font-size:16px;font-weight:700;color:var(--text)">Spotkanie w toku</span>' +
        '<span style="font-size:13px;color:var(--text-dim)">üí¨ ' + liveTranscript.length + ' linii ¬∑ üí° ' + liveCoachingTips.length + ' sugestii</span>' +
      '</div>' +
    '</div>';

    // Live coaching tips
    if (liveCoachingTips.length > 0) {
      var tipItems = liveCoachingTips.slice(-5).reverse().map(function(tip) {
        return '<div style="padding:8px 10px;background:var(--surface2);border-radius:6px;margin-bottom:4px;border-left:3px solid var(--accent)">' +
          '<div style="font-size:13px;color:var(--text);line-height:1.5">' + escapeHtml(tip.tip) + '</div>' +
          (tip.questionText ? '<div style="font-size:11px;color:var(--text-dim);font-style:italic;margin-top:2px">‚ùì ' + escapeHtml(tip.questionText) + '</div>' : '') +
        '</div>';
      }).join('');
      html += '<div class="card">' +
        '<div class="card__title"><span class="icon">üí°</span> Sugestie live (' + liveCoachingTips.length + ')</div>' +
        tipItems +
      '</div>';
    }

    // Live transcript
    html += '<div class="card">' +
      '<div class="card__title"><span class="icon">üìú</span> Transkrypcja live</div>' +
      '<div id="liveTranscriptContainer" style="max-height:500px;overflow-y:auto">';

    var lines = liveTranscript.slice(-100);
    lines.forEach(function(line) {
      var time = new Date(line.timestamp).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      var isMe = line.speaker === 'Ja';
      var color = isMe ? 'var(--accent2)' : 'var(--purple)';
      html += '<div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--surface2);font-size:12px">' +
        '<span style="color:var(--text-muted);flex-shrink:0;min-width:60px">' + time + '</span>' +
        '<span style="color:' + color + ';font-weight:600;flex-shrink:0;min-width:80px">' + escapeHtml(line.speaker) + '</span>' +
        '<span style="color:var(--text)">' + escapeHtml(line.text) + '</span>' +
      '</div>';
    });

    html += '</div></div>';
    el.innerHTML = html;

    // Auto-scroll
    var container = document.getElementById('liveTranscriptContainer');
    if (container) container.scrollTop = container.scrollHeight;
  }

  function updateLiveTranscript() {
    var container = document.getElementById('liveTranscriptContainer');
    if (!container) { renderMeetingLive($('#mainContent')); return; }

    var line = liveTranscript[liveTranscript.length - 1];
    if (!line) return;
    var time = new Date(line.timestamp).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    var isMe = line.speaker === 'Ja';
    var color = isMe ? 'var(--accent2)' : 'var(--purple)';
    var div = document.createElement('div');
    div.style.cssText = 'display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--surface2);font-size:12px';
    div.innerHTML = '<span style="color:var(--text-muted);flex-shrink:0;min-width:60px">' + time + '</span>' +
      '<span style="color:' + color + ';font-weight:600;flex-shrink:0;min-width:80px">' + escapeHtml(line.speaker) + '</span>' +
      '<span style="color:var(--text)">' + escapeHtml(line.text) + '</span>';
    container.appendChild(div);

    // Keep max 100 lines visible
    while (container.children.length > 100) container.removeChild(container.firstChild);
    container.scrollTop = container.scrollHeight;

    // Update line count in header
    var titleEl = container.parentElement.querySelector('.card__title');
    if (titleEl) titleEl.innerHTML = '<span class="icon">üìú</span> Transkrypcja live (' + liveTranscript.length + ' linii)';
  }

  function updateLiveCoaching() {
    // Re-render the whole live page to include new tip
    if (currentPage === 'meeting-live') renderMeetingLive($('#mainContent'));
  }

  function renderActivity(el) {
    api('/api/activity?limit=50').then(function(activity) {
      activity = activity || [];
      if (!activity.length) { el.innerHTML = '<div class="empty"><div class="empty__icon">üìã</div>Brak aktywno≈õci</div>'; return; }
      var items = activity.map(function(a) {
        return '<div class="activity-item">' +
          '<span class="activity-item__time">' + new Date(a.timestamp).toLocaleTimeString('pl',{hour:'2-digit',minute:'2-digit'}) + '</span>' +
          '<span class="badge badge--blue">' + a.category + '</span>' +
          '<span class="activity-item__action">' + a.action + '</span>' +
        '</div>';
      }).join('');
      el.innerHTML =
        '<div class="card"><div class="card__title"><span class="icon">üìã</span> Ostatnia aktywno≈õƒá</div>' +
        items + '</div>';
    });
  }

  function renderShortcuts(el) {
    var shortcuts = [
      { keys: ['Ctrl','Shift','K'], desc: 'Przejmij sterowanie (toggle)' },
      { keys: ['Ctrl','Shift','Space'], desc: 'Otw√≥rz/zamknij czat' },
      { keys: ['Ctrl','Shift','S'], desc: 'Zr√≥b screenshot i analizuj' },
      { keys: ['Ctrl','Shift','P'], desc: 'Tryb proaktywny (toggle)' },
      { keys: ['Ctrl','Shift','M'], desc: 'Meeting Coach (toggle)' },
      { keys: ['Enter'], desc: 'Wy≈õlij wiadomo≈õƒá' },
      { keys: ['Shift','Enter'], desc: 'Nowa linia w czacie' },
      { keys: ['Esc'], desc: 'Zwi≈Ñ widget' }
    ];
    var shortcutHtml = shortcuts.map(function(s) {
      var keysHtml = s.keys.map(function(k) { return '<span class="shortcut__key">' + k + '</span>'; }).join('+');
      return '<div class="shortcut"><span>' + s.desc + '</span><div class="shortcut__keys">' + keysHtml + '</div></div>';
    }).join('');

    el.innerHTML =
      '<div class="card"><div class="card__title"><span class="icon">‚å®Ô∏è</span> Skr√≥ty klawiszowe</div>' + shortcutHtml + '</div>' +
      '<div class="card"><div class="card__title"><span class="icon">üìñ</span> Instrukcja u≈ºycia</div>' +
        '<div style="font-size:13px;color:var(--text-dim);line-height:1.8">' +
          '<p><strong>KxAI</strong> to osobisty AI agent dzia≈ÇajƒÖcy jako floating widget na pulpicie.</p>' +
          '<p>‚Ä¢ <strong>Czat</strong> ‚Äî kliknij widget by otworzyƒá czat z AI</p>' +
          '<p>‚Ä¢ <strong>Screenshot</strong> ‚Äî kliknij üì∏ lub u≈ºyj Ctrl+Shift+S</p>' +
          '<p>‚Ä¢ <strong>Tryb proaktywny</strong> ‚Äî agent sam analizuje ekran i daje wskaz√≥wki</p>' +
          '<p>‚Ä¢ <strong>Cron Jobs</strong> ‚Äî automatyczne zadania uruchamiane wg harmonogramu</p>' +
          '<p>‚Ä¢ <strong>Take Control</strong> ‚Äî agent przejmuje myszkƒô/klawiaturƒô (Ctrl+Shift+K)</p>' +
          '<p>‚Ä¢ <strong>RAG</strong> ‚Äî indeksowanie plik√≥w do semantycznego wyszukiwania</p>' +
          '<p>‚Ä¢ <strong>Meeting Coach</strong> ‚Äî nagrywanie spotka≈Ñ z transkrypcjƒÖ i coachingiem</p>' +
          '<p>‚Ä¢ <strong>Dashboard</strong> ‚Äî ta strona! Monitoruj agenta w przeglƒÖdarce.</p>' +
        '</div>' +
      '</div>';
  }

  // Initial load
  handleHash() || loadPage('overview');
})();
</script>
</body>
</html>
