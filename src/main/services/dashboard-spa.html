<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KxAI Dashboard</title>
  <style>
    :root {
      --bg: #0d1117; --surface: #161b22; --surface2: #21262d; --surface3: #30363d;
      --border: #30363d; --text: #e6edf3; --text-dim: #8b949e; --text-muted: #484f58;
      --accent: #58a6ff; --accent2: #3fb950; --warning: #d29922; --danger: #f85149;
      --purple: #bc8cff; --pink: #f778ba;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }

    .dashboard { display: grid; grid-template-columns: 220px 1fr; grid-template-rows: 56px 1fr; height: 100vh; }
    .topbar {
      grid-column: 1 / -1; background: var(--surface); border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 20px; gap: 12px;
    }
    .topbar__logo { font-size: 24px; }
    .topbar__title { font-size: 16px; font-weight: 600; }
    .topbar__status { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-dim); }
    .topbar__dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); }
    .topbar__dot--busy { background: var(--warning); animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0.3; } }

    .sidebar {
      background: var(--surface); border-right: 1px solid var(--border); padding: 12px 0;
      overflow-y: auto;
    }
    .sidebar__section { padding: 8px 16px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .sidebar__item {
      display: flex; align-items: center; gap: 10px; padding: 8px 16px;
      cursor: pointer; font-size: 13px; color: var(--text-dim); transition: all 0.15s;
      border-left: 2px solid transparent;
    }
    .sidebar__item:hover { background: var(--surface2); color: var(--text); }
    .sidebar__item--active { background: var(--surface2); color: var(--accent); border-left-color: var(--accent); }
    .sidebar__icon { width: 18px; text-align: center; }

    .main { overflow-y: auto; padding: 20px; }

    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .card__title { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .card__title .icon { font-size: 16px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

    .stat { text-align: center; }
    .stat__value { font-size: 28px; font-weight: 700; color: var(--accent); }
    .stat__label { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

    .table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .table th { text-align: left; padding: 8px; border-bottom: 1px solid var(--border); color: var(--text-dim); font-weight: 500; font-size: 11px; text-transform: uppercase; }
    .table td { padding: 8px; border-bottom: 1px solid var(--surface2); }
    .table tr:hover td { background: var(--surface2); }

    .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
    .badge--green { background: rgba(63,185,80,0.15); color: var(--accent2); }
    .badge--blue { background: rgba(88,166,255,0.15); color: var(--accent); }
    .badge--yellow { background: rgba(210,153,34,0.15); color: var(--warning); }
    .badge--red { background: rgba(248,81,73,0.15); color: var(--danger); }
    .badge--purple { background: rgba(188,140,255,0.15); color: var(--purple); }

    .progress-bar { height: 6px; background: var(--surface3); border-radius: 3px; overflow: hidden; }
    .progress-bar__fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.3s; }

    .tool-card {
      background: var(--surface2); border-radius: 6px; padding: 10px 12px; margin-bottom: 6px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .tool-card__name { font-weight: 500; font-size: 13px; }
    .tool-card__cat { font-size: 11px; color: var(--text-dim); }

    .shortcut { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--surface2); font-size: 13px; }
    .shortcut__keys { display: flex; gap: 4px; }
    .shortcut__key {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 4px;
      padding: 2px 8px; font-size: 11px; font-family: monospace; color: var(--text-dim);
    }

    .activity-item { display: flex; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--surface2); font-size: 13px; }
    .activity-item__time { color: var(--text-muted); font-size: 11px; min-width: 50px; }
    .activity-item__action { color: var(--text-dim); }

    .empty { text-align: center; padding: 40px; color: var(--text-muted); }
    .empty__icon { font-size: 40px; margin-bottom: 8px; }

    /* ‚îÄ‚îÄ‚îÄ Graph Visualization ‚îÄ‚îÄ‚îÄ */
    .graph-container { position: relative; width: 100%; height: 400px; background: var(--surface2); border-radius: 8px; overflow: hidden; }
    .graph-node {
      position: absolute; width: 60px; height: 60px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; border: 2px solid var(--border); cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .graph-node:hover { transform: scale(1.15); box-shadow: 0 0 20px rgba(88,166,255,0.3); }
    .graph-node--agent { background: var(--surface); border-color: var(--accent); }
    .graph-node--tool { background: var(--surface); border-color: var(--accent2); }
    .graph-node--cron { background: var(--surface); border-color: var(--warning); }
    .graph-node--rag { background: var(--surface); border-color: var(--purple); }
    .graph-node--system { background: var(--surface); border-color: var(--pink); }
    .graph-label { position: absolute; top: 65px; font-size: 10px; color: var(--text-dim); white-space: nowrap; text-align: center; width: 80px; left: -10px; }
    svg.graph-lines { position: absolute; inset: 0; pointer-events: none; }
    svg.graph-lines line { stroke: var(--border); stroke-width: 1; opacity: 0.5; }
    svg.graph-lines line.active { stroke: var(--accent); stroke-width: 2; opacity: 0.8; animation: line-pulse 2s infinite; }
    @keyframes line-pulse { 50% { opacity: 0.3; } }
  </style>
</head>
<body>
<div class="dashboard" id="app">
  <div class="topbar">
    <span class="topbar__logo">ü§ñ</span>
    <span class="topbar__title">KxAI Dashboard</span>
    <div class="topbar__status">
      <span class="topbar__dot" id="statusDot"></span>
      <span id="statusText">Idle</span>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar__section">PrzeglƒÖd</div>
    <div class="sidebar__item sidebar__item--active" data-page="overview">
      <span class="sidebar__icon">üìä</span> PrzeglƒÖd
    </div>
    <div class="sidebar__item" data-page="graph">
      <span class="sidebar__icon">üï∏Ô∏è</span> Graf agenta
    </div>
    <div class="sidebar__section">ZarzƒÖdzanie</div>
    <div class="sidebar__item" data-page="tools">
      <span class="sidebar__icon">üîß</span> Narzƒôdzia
    </div>
    <div class="sidebar__item" data-page="cron">
      <span class="sidebar__icon">‚è∞</span> Cron Jobs
    </div>
    <div class="sidebar__item" data-page="rag">
      <span class="sidebar__icon">üìö</span> RAG Index
    </div>
    <div class="sidebar__item" data-page="system">
      <span class="sidebar__icon">üíª</span> System
    </div>
    <div class="sidebar__section">Inne</div>
    <div class="sidebar__item" data-page="meetings">
      <span class="sidebar__icon">üéôÔ∏è</span> Spotkania
    </div>
    <div class="sidebar__item" data-page="activity">
      <span class="sidebar__icon">üìã</span> Aktywno≈õƒá
    </div>
    <div class="sidebar__item" data-page="shortcuts">
      <span class="sidebar__icon">‚å®Ô∏è</span> Skr√≥ty
    </div>
  </div>

  <div class="main" id="mainContent">
    <div class="empty"><div class="empty__icon">‚è≥</div>≈Åadowanie...</div>
  </div>
</div>

<script>
(function() {
  var $ = function(s, p) { return (p || document).querySelector(s); };
  var $$ = function(s, p) { return Array.from((p || document).querySelectorAll(s)); };
  var API = '';
  var currentPage = 'overview';
  var wsConn = null;
  var agentStatus = { state: 'idle' };
  var liveMeetingState = null;
  var liveTranscript = [];
  var liveCoachingTips = [];

  // WebSocket
  function connectWS() {
    var proto = location.protocol === 'https:' ? 'wss' : 'ws';
    wsConn = new WebSocket(proto + '://' + location.host + '/');
    wsConn.onmessage = function(e) {
      try {
        var msg = JSON.parse(e.data);
        if (msg.type === 'agent:status') {
          agentStatus = msg.data;
          updateStatusIndicator();
          if (currentPage === 'overview' || currentPage === 'graph') loadPage(currentPage);
        }
        // Meeting live events
        if (msg.type === 'meeting:state') {
          liveMeetingState = msg.data;
          if (currentPage === 'meetings' || currentPage === 'meeting-live') {
            loadPage(currentPage);
          }
        }
        if (msg.type === 'meeting:transcript' && msg.data) {
          if (msg.data.line) {
            liveTranscript.push(msg.data.line);
            if (currentPage === 'meeting-live') updateLiveTranscript();
          }
        }
        if (msg.type === 'meeting:coaching-done' && msg.data) {
          liveCoachingTips.push(msg.data);
          if (currentPage === 'meeting-live') updateLiveCoaching();
        }
        if (msg.type === 'meeting:started') {
          liveTranscript = [];
          liveCoachingTips = [];
          liveMeetingState = { active: true };
        }
        if (msg.type === 'meeting:stopped') {
          liveMeetingState = null;
          if (currentPage === 'meeting-live') loadPage('meetings');
        }
      } catch(ex) {}
    };
    wsConn.onclose = function() { setTimeout(connectWS, 3000); };
  }
  connectWS();

  function updateStatusIndicator() {
    var dot = $('#statusDot');
    var txt = $('#statusText');
    var busy = agentStatus.state !== 'idle';
    dot.className = 'topbar__dot' + (busy ? ' topbar__dot--busy' : '');
    var labels = { idle:'Idle', thinking:'My≈õlenie...', 'tool-calling':'Narzƒôdzie: '+(agentStatus.toolName||''), streaming:'Streaming', heartbeat:'Heartbeat', 'take-control':'Sterowanie', 'sub-agent':'Sub-agent' };
    txt.textContent = labels[agentStatus.state] || agentStatus.state;
  }

  // Navigation
  $$('.sidebar__item').forEach(function(item) {
    item.onclick = function() {
      $$('.sidebar__item').forEach(function(i) { i.classList.remove('sidebar__item--active'); });
      item.classList.add('sidebar__item--active');
      currentPage = item.dataset.page;
      loadPage(currentPage);
    };
  });

  function api(path) {
    return fetch(API + path)
      .then(function(r) { return r.json(); })
      .then(function(j) { return j.data; })
      .catch(function() { return null; });
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function loadPage(page) {
    var main = $('#mainContent');
    switch(page) {
      case 'overview': return renderOverview(main);
      case 'graph': return renderGraph(main);
      case 'tools': return renderTools(main);
      case 'cron': return renderCron(main);
      case 'rag': return renderRag(main);
      case 'system': return renderSystem(main);
      case 'meetings': return renderMeetings(main);
      case 'meeting-live': return renderMeetingLive(main);
      case 'activity': return renderActivity(main);
      case 'shortcuts': return renderShortcuts(main);
      default:
        if (page && page.indexOf('meeting/') === 0) {
          return renderMeetingDetail(main, page.replace('meeting/', ''));
        }
    }
  }

  // Handle hash-based routing for meeting details
  function handleHash() {
    var hash = location.hash.replace('#/', '').replace('#', '');
    if (hash.indexOf('meeting/') === 0) {
      currentPage = hash;
      $$('.sidebar__item').forEach(function(i) { i.classList.remove('sidebar__item--active'); });
      $$('.sidebar__item[data-page="meetings"]').forEach(function(i) { i.classList.add('sidebar__item--active'); });
      loadPage(hash);
    } else if (hash === 'meetings') {
      currentPage = 'meetings';
      $$('.sidebar__item').forEach(function(i) { i.classList.remove('sidebar__item--active'); });
      $$('.sidebar__item[data-page="meetings"]').forEach(function(i) { i.classList.add('sidebar__item--active'); });
      loadPage('meetings');
    }
  }
  window.addEventListener('hashchange', handleHash);

  function renderOverview(el) {
    Promise.all([
      api('/api/status'), api('/api/rag'), api('/api/cron'), api('/api/subagents')
    ]).then(function(results) {
      var status = results[0], rag = results[1], cron = results[2], subagents = results[3];
      var ragData = rag || { totalChunks: 0, totalFiles: 0, embeddingType: '-' };
      var cronJobs = cron || [];
      var enabledCron = cronJobs.filter(function(j) { return j.enabled; }).length;
      var activeSubagents = subagents && subagents.active ? subagents.active.length : 0;
      var uptimeH = status ? Math.round(status.uptime / 3600) : 0;
      var memMB = status ? Math.round(status.memory.heapUsed / 1024 / 1024) : 0;

      el.innerHTML =
        '<div class="grid-3">' +
          '<div class="card"><div class="stat"><div class="stat__value">' + ragData.totalFiles + '</div><div class="stat__label">Zaindeksowanych plik√≥w</div></div></div>' +
          '<div class="card"><div class="stat"><div class="stat__value">' + ragData.totalChunks + '</div><div class="stat__label">Fragment√≥w RAG</div></div></div>' +
          '<div class="card"><div class="stat"><div class="stat__value">' + enabledCron + '/' + cronJobs.length + '</div><div class="stat__label">Aktywnych Cron Jobs</div></div></div>' +
        '</div>' +
        '<div class="grid-2">' +
          '<div class="card">' +
            '<div class="card__title"><span class="icon">ü§ñ</span> Status agenta</div>' +
            '<table class="table">' +
              '<tr><td>Stan</td><td><span class="badge badge--' + (agentStatus.state==='idle'?'green':'yellow') + '">' + agentStatus.state + '</span></td></tr>' +
              '<tr><td>Szczeg√≥≈Çy</td><td>' + escapeHtml(agentStatus.detail || '-') + '</td></tr>' +
              '<tr><td>Sub-agenci</td><td>' + activeSubagents + '</td></tr>' +
              '<tr><td>Uptime</td><td>' + uptimeH + 'h</td></tr>' +
              '<tr><td>Pamiƒôƒá</td><td>' + memMB + ' MB</td></tr>' +
            '</table>' +
          '</div>' +
          '<div class="card">' +
            '<div class="card__title"><span class="icon">üìö</span> RAG Index</div>' +
            '<table class="table">' +
              '<tr><td>Pliki</td><td>' + ragData.totalFiles + '</td></tr>' +
              '<tr><td>Fragmenty</td><td>' + ragData.totalChunks + '</td></tr>' +
              '<tr><td>Embeddingi</td><td><span class="badge badge--blue">' + ragData.embeddingType + '</span></td></tr>' +
              '<tr><td>Foldery</td><td>' + (ragData.folders ? ragData.folders.length : 0) + '</td></tr>' +
            '</table>' +
          '</div>' +
        '</div>';
    });
  }

  function renderGraph(el) {
    Promise.all([
      api('/api/subagents'), api('/api/rag'), api('/api/cron')
    ]).then(function(results) {
      var subagents = results[0], rag = results[1], cron = results[2];
      var activeSubagents = subagents && subagents.active ? subagents.active : [];
      var cronJobs = (cron || []).filter(function(j) { return j.enabled; }).slice(0, 5);
      var ragFolders = rag && rag.folders ? rag.folders : [];

      var cx = 350, cy = 180;
      var nodes = [{ id:'agent', label:'Agent', emoji:'ü§ñ', cls:'agent', x:cx, y:cy }];
      var lines = [];
      var totalItems = activeSubagents.length + cronJobs.length + 3; // +tools, +rag, +system
      var angleStep = (2 * Math.PI) / Math.max(4, totalItems);
      var idx = 0;

      activeSubagents.forEach(function(sa, i) {
        var a = angleStep * idx++; var nx = cx + 140 * Math.cos(a); var ny = cy + 120 * Math.sin(a);
        nodes.push({ id:'sa-'+i, label:(sa.task||'Sub-agent').slice(0,15), emoji:'ü§ñ', cls:'agent', x:nx, y:ny });
        lines.push({ from:'agent', to:'sa-'+i, active: sa.status==='running' });
      });

      var a1 = angleStep * idx++;
      nodes.push({ id:'tools', label:'Narzƒôdzia', emoji:'üîß', cls:'tool', x:cx+140*Math.cos(a1), y:cy+120*Math.sin(a1) });
      lines.push({ from:'agent', to:'tools', active:agentStatus.state==='tool-calling' });

      cronJobs.forEach(function(cj, i) {
        var a = angleStep * idx++; var nx = cx + 140*Math.cos(a); var ny = cy + 120*Math.sin(a);
        nodes.push({ id:'cron-'+i, label:(cj.name||'Cron').slice(0,15), emoji:'‚è∞', cls:'cron', x:nx, y:ny });
        lines.push({ from:'agent', to:'cron-'+i, active:false });
      });

      var a2 = angleStep * idx++;
      nodes.push({ id:'rag', label:'RAG Index', emoji:'üìö', cls:'rag', x:cx+140*Math.cos(a2), y:cy+120*Math.sin(a2) });
      lines.push({ from:'agent', to:'rag', active:false });

      var a3 = angleStep * idx++;
      nodes.push({ id:'sys', label:'System', emoji:'üíª', cls:'system', x:cx+140*Math.cos(a3), y:cy+120*Math.sin(a3) });
      lines.push({ from:'agent', to:'sys', active:false });

      var svgLines = lines.map(function(l) {
        var fromN = nodes.find(function(n) { return n.id===l.from; });
        var toN = nodes.find(function(n) { return n.id===l.to; });
        return '<line x1="' + (fromN.x+30) + '" y1="' + (fromN.y+30) + '" x2="' + (toN.x+30) + '" y2="' + (toN.y+30) + '" class="' + (l.active?'active':'') + '"/>';
      }).join('');

      var nodeEls = nodes.map(function(n) {
        return '<div class="graph-node graph-node--' + n.cls + '" style="left:' + n.x + 'px;top:' + n.y + 'px" title="' + n.label + '">' +
          n.emoji +
          '<div class="graph-label">' + n.label + '</div>' +
        '</div>';
      }).join('');

      el.innerHTML =
        '<div class="card">' +
          '<div class="card__title"><span class="icon">üï∏Ô∏è</span> Graf po≈ÇƒÖcze≈Ñ agenta</div>' +
          '<div class="graph-container">' +
            '<svg class="graph-lines" width="100%" height="100%">' + svgLines + '</svg>' +
            nodeEls +
          '</div>' +
        '</div>';
    });
  }

  function renderTools(el) {
    api('/api/tools').then(function(tools) {
      tools = tools || [];
      var cats = {};
      tools.forEach(function(t) { (cats[t.category] = cats[t.category] || []).push(t); });

      var html = '<div class="card"><div class="card__title"><span class="icon">üîß</span> Dostƒôpne narzƒôdzia (' + tools.length + ')</div>';
      Object.keys(cats).forEach(function(cat) {
        html += '<h4 style="margin:12px 0 6px;color:var(--text-dim);font-size:12px;text-transform:uppercase">' + cat + '</h4>';
        cats[cat].forEach(function(t) {
          var paramCount = t.parameters ? Object.keys(t.parameters).length : 0;
          html += '<div class="tool-card"><div><div class="tool-card__name">' + t.name + '</div><div class="tool-card__cat">' + t.description + '</div></div><span class="badge badge--blue">' + paramCount + ' params</span></div>';
        });
      });
      html += '</div>';
      el.innerHTML = html;
    });
  }

  function renderCron(el) {
    api('/api/cron').then(function(jobs) {
      jobs = jobs || [];
      var rows = jobs.map(function(j) {
        return '<tr>' +
          '<td>' + j.name + '</td>' +
          '<td><code>' + j.schedule + '</code></td>' +
          '<td><span class="badge badge--purple">' + j.category + '</span></td>' +
          '<td><span class="badge badge--' + (j.enabled?'green':'red') + '">' + (j.enabled?'Aktywny':'Wy≈ÇƒÖczony') + '</span></td>' +
          '<td>' + j.runCount + '</td>' +
          '<td>' + (j.lastRun ? new Date(j.lastRun).toLocaleString('pl') : '-') + '</td>' +
        '</tr>';
      }).join('');
      el.innerHTML =
        '<div class="card"><div class="card__title"><span class="icon">‚è∞</span> Cron Jobs (' + jobs.length + ')</div>' +
        '<table class="table"><thead><tr><th>Nazwa</th><th>Harmonogram</th><th>Kategoria</th><th>Status</th><th>Uruchomie≈Ñ</th><th>Ostatnio</th></tr></thead><tbody>' +
        rows + '</tbody></table></div>';
    });
  }

  function renderRag(el) {
    api('/api/rag').then(function(rag) {
      if (!rag) { el.innerHTML = '<div class="empty"><div class="empty__icon">üìö</div>RAG nie jest skonfigurowany</div>'; return; }
      var folderRows = (rag.folders || []).map(function(f) {
        return '<tr><td>' + f.path + '</td><td>' + f.fileCount + '</td><td>' + f.chunkCount + '</td><td>' + (f.lastIndexed ? new Date(f.lastIndexed).toLocaleString('pl') : '-') + '</td></tr>';
      }).join('');
      el.innerHTML =
        '<div class="grid-3">' +
          '<div class="card"><div class="stat"><div class="stat__value">' + rag.totalFiles + '</div><div class="stat__label">Plik√≥w</div></div></div>' +
          '<div class="card"><div class="stat"><div class="stat__value">' + rag.totalChunks + '</div><div class="stat__label">Fragment√≥w</div></div></div>' +
          '<div class="card"><div class="stat"><div class="stat__value badge badge--blue">' + rag.embeddingType + '</div><div class="stat__label">Typ embedding√≥w</div></div></div>' +
        '</div>' +
        '<div class="card"><div class="card__title"><span class="icon">üìÅ</span> Zaindeksowane foldery</div>' +
        '<table class="table"><thead><tr><th>≈öcie≈ºka</th><th>Pliki</th><th>Fragmenty</th><th>Ostatnie indeksowanie</th></tr></thead><tbody>' +
        folderRows + '</tbody></table></div>';
    });
  }

  function renderSystem(el) {
    api('/api/system').then(function(sys) {
      if (!sys) { el.innerHTML = '<div class="empty"><div class="empty__icon">üíª</div>System monitor niedostƒôpny</div>'; return; }
      var batteryHtml = sys.battery
        ? '<div class="stat"><div class="stat__value">' + sys.battery.percent + '%</div><div class="stat__label">' + (sys.battery.charging?'≈Åadowanie':'Na baterii') + ' ¬∑ ' + sys.battery.timeRemaining + '</div></div>'
        : '<div class="stat"><div class="stat__label">Brak baterii</div></div>';
      el.innerHTML =
        '<div class="grid-3">' +
          '<div class="card"><div class="card__title"><span class="icon">üñ•Ô∏è</span> CPU</div>' +
            '<div class="stat"><div class="stat__value">' + Math.round(sys.cpu.usagePercent) + '%</div><div class="stat__label">' + sys.cpu.model + ' ¬∑ ' + sys.cpu.cores + ' rdzeni</div></div>' +
            '<div class="progress-bar" style="margin-top:8px"><div class="progress-bar__fill" style="width:' + sys.cpu.usagePercent + '%"></div></div></div>' +
          '<div class="card"><div class="card__title"><span class="icon">üíæ</span> RAM</div>' +
            '<div class="stat"><div class="stat__value">' + sys.memory.usedGB.toFixed(1) + ' / ' + sys.memory.totalGB.toFixed(1) + ' GB</div><div class="stat__label">' + Math.round(sys.memory.usagePercent) + '% u≈ºycia</div></div>' +
            '<div class="progress-bar" style="margin-top:8px"><div class="progress-bar__fill" style="width:' + sys.memory.usagePercent + '%"></div></div></div>' +
          '<div class="card"><div class="card__title"><span class="icon">üîã</span> Bateria</div>' + batteryHtml + '</div>' +
        '</div>' +
        '<div class="card"><div class="card__title"><span class="icon">üì°</span> System</div>' +
        '<table class="table">' +
          '<tr><td>Host</td><td>' + sys.system.hostname + '</td></tr>' +
          '<tr><td>OS</td><td>' + sys.system.platform + ' ' + sys.system.arch + ' ¬∑ ' + sys.system.osVersion + '</td></tr>' +
          '<tr><td>Uptime</td><td>' + sys.system.uptimeHours.toFixed(1) + 'h</td></tr>' +
          '<tr><td>Node</td><td>' + sys.system.nodeVersion + '</td></tr>' +
          '<tr><td>Electron</td><td>' + sys.system.electronVersion + '</td></tr>' +
          '<tr><td>Sieƒá</td><td>' + (sys.network.connected ? '‚úÖ Po≈ÇƒÖczono' : '‚ùå Brak sieci') + '</td></tr>' +
        '</table></div>';
    });
  }

  function renderMeetings(el) {
    api('/api/meetings').then(function(meetings) {
      meetings = meetings || [];

      // Live meeting banner
      var liveBanner = '';
      if (liveMeetingState && liveMeetingState.active) {
        liveBanner =
          '<div class="card" style="border-color:#f85149;background:rgba(248,81,73,0.05)">' +
            '<div class="card__title"><span class="icon" style="animation:blink 1s infinite">üî¥</span> Spotkanie w toku</div>' +
            '<div style="display:flex;justify-content:space-between;align-items:center">' +
              '<div style="font-size:13px;color:var(--text-dim)">' +
                'üí¨ ' + (liveMeetingState.transcriptLineCount || liveTranscript.length) + ' linii transkrypcji ¬∑ ' +
                'üí° ' + liveCoachingTips.length + ' sugestii' +
              '</div>' +
              '<button onclick="currentPage=\'meeting-live\';loadPage(\'meeting-live\')" style="background:rgba(88,166,255,0.12);color:var(--accent);border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px">üì° PodglƒÖd live ‚Üí</button>' +
            '</div>' +
          '</div>';
      }

      if (!meetings.length && !liveBanner) {
        el.innerHTML = '<div class="empty"><div class="empty__icon">üéôÔ∏è</div>Brak spotka≈Ñ</div>';
        return;
      }

      var rows = meetings.map(function(m) {
        var durationStr = m.duration + ' min';
        var participantCount = m.participants ? m.participants.length : 0;
        var dateStr = new Date(m.startTime).toLocaleDateString('pl', { day: '2-digit', month: '2-digit', year: 'numeric' });
        var timeStr = new Date(m.startTime).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit' });
        var hasSummary = m.summary && m.summary.length > 10;
        return '<tr style="cursor:pointer" onclick="currentPage=\'meeting/' + m.id + '\';loadPage(\'meeting/' + m.id + '\')">' +
          '<td><strong style="color:var(--accent)">' + escapeHtml(m.title) + '</strong></td>' +
          '<td>' + dateStr + ' ' + timeStr + '</td>' +
          '<td>' + durationStr + '</td>' +
          '<td>' + participantCount + '</td>' +
          '<td>' + (hasSummary ? '<span class="badge badge--green">‚úì</span>' : '<span class="badge badge--yellow">‚Äî</span>') + '</td>' +
        '</tr>';
      }).join('');

      el.innerHTML = liveBanner +
        '<div class="card"><div class="card__title"><span class="icon">üéôÔ∏è</span> Spotkania (' + meetings.length + ')</div>' +
        '<table class="table"><thead><tr><th>Tytu≈Ç</th><th>Data</th><th>Czas trwania</th><th>Uczestnicy</th><th>Podsumowanie</th></tr></thead><tbody>' +
        rows + '</tbody></table></div>';
    });
  }

  function renderMeetingDetail(el, meetingId) {
    api('/api/meeting/' + meetingId).then(function(m) {
      if (!m) {
        el.innerHTML = '<div class="empty"><div class="empty__icon">‚ùå</div>Nie znaleziono spotkania</div>';
        return;
      }

      var dateStr = new Date(m.startTime).toLocaleDateString('pl', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      var timeStart = new Date(m.startTime).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit' });
      var timeEnd = new Date(m.endTime).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit' });

      // Header
      var html = '<div style="margin-bottom:8px"><button onclick="currentPage=\'meetings\';loadPage(\'meetings\')" style="background:transparent;color:var(--accent);border:none;cursor:pointer;font-size:13px;padding:4px 0">‚Üê Powr√≥t do listy</button></div>';

      html += '<div class="card" style="border-color:var(--accent)">' +
        '<div style="display:flex;justify-content:space-between;align-items:flex-start">' +
          '<div>' +
            '<h2 style="margin:0 0 4px;font-size:18px;color:var(--text)">' + escapeHtml(m.title) + '</h2>' +
            '<div style="font-size:13px;color:var(--text-dim)">' +
              'üìÖ ' + dateStr + ' ¬∑ ' + timeStart + ' ‚Äì ' + timeEnd + ' ¬∑ ‚è± ' + m.duration + ' min' +
            '</div>' +
          '</div>' +
          (m.detectedApp ? '<span class="badge badge--blue">' + escapeHtml(m.detectedApp) + '</span>' : '') +
        '</div>' +
      '</div>';

      // Summary
      if (m.summary) {
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üìù</span> Podsumowanie</div>' +
          '<p style="font-size:14px;line-height:1.7;color:var(--text);margin:0">' + escapeHtml(m.summary) + '</p>' +
        '</div>';
      }

      // Stats row
      html += '<div class="grid-3">' +
        '<div class="card"><div class="stat"><div class="stat__value">' + (m.participants ? m.participants.length : 0) + '</div><div class="stat__label">Uczestnik√≥w</div></div></div>' +
        '<div class="card"><div class="stat"><div class="stat__value">' + (m.transcript ? m.transcript.length : 0) + '</div><div class="stat__label">Linii transkrypcji</div></div></div>' +
        '<div class="card"><div class="stat"><div class="stat__value">' + (m.coachingTips ? m.coachingTips.length : 0) + '</div><div class="stat__label">Sugestii coachinga</div></div></div>' +
      '</div>';

      // Key Points & Action Items
      var hasKeyPoints = m.keyPoints && m.keyPoints.length > 0;
      var hasActionItems = m.actionItems && m.actionItems.length > 0;
      if (hasKeyPoints || hasActionItems) {
        html += '<div class="grid-2">';
        if (hasKeyPoints) {
          html += '<div class="card">' +
            '<div class="card__title"><span class="icon">üéØ</span> Kluczowe punkty</div>' +
            '<ul style="margin:0;padding-left:20px;font-size:13px;line-height:1.8;color:var(--text)">' +
            m.keyPoints.map(function(p) { return '<li>' + escapeHtml(p) + '</li>'; }).join('') +
            '</ul></div>';
        }
        if (hasActionItems) {
          html += '<div class="card">' +
            '<div class="card__title"><span class="icon">‚úÖ</span> Dzia≈Çania do podjƒôcia</div>' +
            '<ul style="margin:0;padding-left:20px;font-size:13px;line-height:1.8;color:var(--text)">' +
            m.actionItems.map(function(a) { return '<li>' + escapeHtml(a) + '</li>'; }).join('') +
            '</ul></div>';
        }
        html += '</div>';
      }

      // Participants
      if (m.speakers && m.speakers.length > 0) {
        var participantCards = m.speakers.map(function(s) {
          var isMe = s.name === 'Ja';
          var color = isMe ? 'var(--accent2)' : 'var(--purple)';
          return '<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:var(--surface2);border-radius:8px">' +
            '<div style="width:36px;height:36px;border-radius:50%;background:' + (isMe ? 'rgba(63,185,80,0.15)' : 'rgba(188,140,255,0.15)') + ';display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">' +
              (isMe ? 'üë§' : 'üéôÔ∏è') +
            '</div>' +
            '<div style="flex:1;min-width:0">' +
              '<div style="font-size:13px;font-weight:600;color:' + color + '">' + escapeHtml(s.name) + '</div>' +
              '<div style="font-size:11px;color:var(--text-muted)">' + s.utteranceCount + ' wypowiedzi' + (s.isAutoDetected ? ' ¬∑ auto-detected' : '') + '</div>' +
            '</div>' +
          '</div>';
        }).join('');
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üë•</span> Uczestnicy</div>' +
          '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">' + participantCards + '</div>' +
        '</div>';
      }

      // Coaching Tips
      if (m.coachingTips && m.coachingTips.length > 0) {
        var tipItems = m.coachingTips.map(function(tip) {
          var catEmoji = { answer: 'üí¨', communication: 'üó£Ô∏è', technical: '‚öôÔ∏è', strategy: '‚ôüÔ∏è' };
          var catColor = { answer: 'var(--accent)', communication: 'var(--accent2)', technical: 'var(--warning)', strategy: 'var(--purple)' };
          var emoji = catEmoji[tip.category] || 'üí°';
          var color = catColor[tip.category] || 'var(--text-dim)';
          var time = new Date(tip.timestamp).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          return '<div style="padding:10px 12px;background:var(--surface2);border-radius:8px;margin-bottom:6px;border-left:3px solid ' + color + '">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:4px">' +
              '<span style="font-size:12px;color:' + color + ';font-weight:600">' + emoji + ' ' + (tip.category || 'tip') + '</span>' +
              '<span style="font-size:11px;color:var(--text-muted)">' + time + '</span>' +
            '</div>' +
            (tip.questionText ? '<div style="font-size:11px;color:var(--text-dim);font-style:italic;margin-bottom:4px">‚ùì ' + escapeHtml(tip.questionText) + '</div>' : '') +
            '<div style="font-size:13px;color:var(--text);line-height:1.5">' + escapeHtml(tip.tip) + '</div>' +
          '</div>';
        }).join('');
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üí°</span> Sugestie coachinga (' + m.coachingTips.length + ')</div>' +
          tipItems +
        '</div>';
      }

      // Transcript
      if (m.transcript && m.transcript.length > 0) {
        var transcriptLines = m.transcript.map(function(line) {
          var time = new Date(line.timestamp).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          var isMe = line.speaker === 'Ja';
          var color = isMe ? '#3fb950' : '#bc8cff';
          return '<div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--surface2);font-size:12px">' +
            '<span style="color:var(--text-muted);flex-shrink:0;min-width:60px">' + time + '</span>' +
            '<span style="color:' + color + ';font-weight:600;flex-shrink:0;min-width:80px">' + escapeHtml(line.speaker) + '</span>' +
            '<span style="color:var(--text)">' + escapeHtml(line.text) + '</span>' +
          '</div>';
        }).join('');
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üìú</span> Pe≈Çna transkrypcja (' + m.transcript.length + ' linii)</div>' +
          '<div style="max-height:500px;overflow-y:auto">' + transcriptLines + '</div>' +
        '</div>';
      }

      // Briefing
      if (m.briefing && m.briefing.topic) {
        html += '<div class="card">' +
          '<div class="card__title"><span class="icon">üìã</span> Briefing pre-meeting</div>' +
          '<table class="table">' +
            '<tr><td style="width:120px">Temat</td><td>' + escapeHtml(m.briefing.topic) + '</td></tr>' +
            (m.briefing.agenda ? '<tr><td>Agenda</td><td>' + escapeHtml(m.briefing.agenda) + '</td></tr>' : '') +
            (m.briefing.notes ? '<tr><td>Notatki</td><td>' + escapeHtml(m.briefing.notes) + '</td></tr>' : '') +
            (m.briefing.participants && m.briefing.participants.length > 0 ?
              '<tr><td>Uczestnicy</td><td>' + m.briefing.participants.map(function(p) { return escapeHtml(p.name) + (p.role ? ' (' + escapeHtml(p.role) + ')' : ''); }).join(', ') + '</td></tr>' : '') +
          '</table>' +
        '</div>';
      }

      el.innerHTML = html;
    });
  }

  function renderMeetingLive(el) {
    if (!liveMeetingState || !liveMeetingState.active) {
      el.innerHTML = '<div class="empty"><div class="empty__icon">üéôÔ∏è</div>Brak aktywnego spotkania<br><button onclick="currentPage=\'meetings\';loadPage(\'meetings\')" style="margin-top:12px;background:rgba(88,166,255,0.12);color:var(--accent);border:none;border-radius:6px;padding:8px 16px;cursor:pointer">‚Üê Powr√≥t do spotka≈Ñ</button></div>';
      return;
    }

    var html = '<div style="margin-bottom:8px"><button onclick="currentPage=\'meetings\';loadPage(\'meetings\')" style="background:transparent;color:var(--accent);border:none;cursor:pointer;font-size:13px;padding:4px 0">‚Üê Powr√≥t do listy</button></div>';

    // Live status
    html += '<div class="card" style="border-color:#f85149">' +
      '<div style="display:flex;align-items:center;gap:10px">' +
        '<span style="width:10px;height:10px;border-radius:50%;background:#f85149;box-shadow:0 0 8px rgba(248,81,73,0.6);animation:blink 1s infinite"></span>' +
        '<span style="font-size:16px;font-weight:700;color:var(--text)">Spotkanie w toku</span>' +
        '<span style="font-size:13px;color:var(--text-dim)">üí¨ ' + liveTranscript.length + ' linii ¬∑ üí° ' + liveCoachingTips.length + ' sugestii</span>' +
      '</div>' +
    '</div>';

    // Live coaching tips
    if (liveCoachingTips.length > 0) {
      var tipItems = liveCoachingTips.slice(-5).reverse().map(function(tip) {
        return '<div style="padding:8px 10px;background:var(--surface2);border-radius:6px;margin-bottom:4px;border-left:3px solid var(--accent)">' +
          '<div style="font-size:13px;color:var(--text);line-height:1.5">' + escapeHtml(tip.tip) + '</div>' +
          (tip.questionText ? '<div style="font-size:11px;color:var(--text-dim);font-style:italic;margin-top:2px">‚ùì ' + escapeHtml(tip.questionText) + '</div>' : '') +
        '</div>';
      }).join('');
      html += '<div class="card">' +
        '<div class="card__title"><span class="icon">üí°</span> Sugestie live (' + liveCoachingTips.length + ')</div>' +
        tipItems +
      '</div>';
    }

    // Live transcript
    html += '<div class="card">' +
      '<div class="card__title"><span class="icon">üìú</span> Transkrypcja live</div>' +
      '<div id="liveTranscriptContainer" style="max-height:500px;overflow-y:auto">';

    var lines = liveTranscript.slice(-100);
    lines.forEach(function(line) {
      var time = new Date(line.timestamp).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      var isMe = line.speaker === 'Ja';
      var color = isMe ? '#3fb950' : '#bc8cff';
      html += '<div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--surface2);font-size:12px">' +
        '<span style="color:var(--text-muted);flex-shrink:0;min-width:60px">' + time + '</span>' +
        '<span style="color:' + color + ';font-weight:600;flex-shrink:0;min-width:80px">' + escapeHtml(line.speaker) + '</span>' +
        '<span style="color:var(--text)">' + escapeHtml(line.text) + '</span>' +
      '</div>';
    });

    html += '</div></div>';
    el.innerHTML = html;

    // Auto-scroll
    var container = document.getElementById('liveTranscriptContainer');
    if (container) container.scrollTop = container.scrollHeight;
  }

  function updateLiveTranscript() {
    var container = document.getElementById('liveTranscriptContainer');
    if (!container) { renderMeetingLive($('#mainContent')); return; }

    var line = liveTranscript[liveTranscript.length - 1];
    if (!line) return;
    var time = new Date(line.timestamp).toLocaleTimeString('pl', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    var isMe = line.speaker === 'Ja';
    var color = isMe ? '#3fb950' : '#bc8cff';
    var div = document.createElement('div');
    div.style.cssText = 'display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--surface2);font-size:12px';
    div.innerHTML = '<span style="color:var(--text-muted);flex-shrink:0;min-width:60px">' + time + '</span>' +
      '<span style="color:' + color + ';font-weight:600;flex-shrink:0;min-width:80px">' + escapeHtml(line.speaker) + '</span>' +
      '<span style="color:var(--text)">' + escapeHtml(line.text) + '</span>';
    container.appendChild(div);

    // Keep max 100 lines visible
    while (container.children.length > 100) container.removeChild(container.firstChild);
    container.scrollTop = container.scrollHeight;

    // Update line count in header
    var titleEl = container.parentElement.querySelector('.card__title');
    if (titleEl) titleEl.innerHTML = '<span class="icon">üìú</span> Transkrypcja live (' + liveTranscript.length + ' linii)';
  }

  function updateLiveCoaching() {
    // Re-render the whole live page to include new tip
    if (currentPage === 'meeting-live') renderMeetingLive($('#mainContent'));
  }

  function renderActivity(el) {
    api('/api/activity?limit=50').then(function(activity) {
      activity = activity || [];
      if (!activity.length) { el.innerHTML = '<div class="empty"><div class="empty__icon">üìã</div>Brak aktywno≈õci</div>'; return; }
      var items = activity.map(function(a) {
        return '<div class="activity-item">' +
          '<span class="activity-item__time">' + new Date(a.timestamp).toLocaleTimeString('pl',{hour:'2-digit',minute:'2-digit'}) + '</span>' +
          '<span class="badge badge--blue">' + a.category + '</span>' +
          '<span class="activity-item__action">' + a.action + '</span>' +
        '</div>';
      }).join('');
      el.innerHTML =
        '<div class="card"><div class="card__title"><span class="icon">üìã</span> Ostatnia aktywno≈õƒá</div>' +
        items + '</div>';
    });
  }

  function renderShortcuts(el) {
    var shortcuts = [
      { keys: ['Ctrl','Shift','K'], desc: 'Przejmij sterowanie (toggle)' },
      { keys: ['Ctrl','Shift','Space'], desc: 'Otw√≥rz/zamknij czat' },
      { keys: ['Ctrl','Shift','S'], desc: 'Zr√≥b screenshot i analizuj' },
      { keys: ['Ctrl','Shift','P'], desc: 'Tryb proaktywny (toggle)' },
      { keys: ['Ctrl','Shift','M'], desc: 'Meeting Coach (toggle)' },
      { keys: ['Enter'], desc: 'Wy≈õlij wiadomo≈õƒá' },
      { keys: ['Shift','Enter'], desc: 'Nowa linia w czacie' },
      { keys: ['Esc'], desc: 'Zwi≈Ñ widget' }
    ];
    var shortcutHtml = shortcuts.map(function(s) {
      var keysHtml = s.keys.map(function(k) { return '<span class="shortcut__key">' + k + '</span>'; }).join('+');
      return '<div class="shortcut"><span>' + s.desc + '</span><div class="shortcut__keys">' + keysHtml + '</div></div>';
    }).join('');

    el.innerHTML =
      '<div class="card"><div class="card__title"><span class="icon">‚å®Ô∏è</span> Skr√≥ty klawiszowe</div>' + shortcutHtml + '</div>' +
      '<div class="card"><div class="card__title"><span class="icon">üìñ</span> Instrukcja u≈ºycia</div>' +
        '<div style="font-size:13px;color:var(--text-dim);line-height:1.8">' +
          '<p><strong>KxAI</strong> to osobisty AI agent dzia≈ÇajƒÖcy jako floating widget na pulpicie.</p>' +
          '<p>‚Ä¢ <strong>Czat</strong> ‚Äî kliknij widget by otworzyƒá czat z AI</p>' +
          '<p>‚Ä¢ <strong>Screenshot</strong> ‚Äî kliknij üì∏ lub u≈ºyj Ctrl+Shift+S</p>' +
          '<p>‚Ä¢ <strong>Tryb proaktywny</strong> ‚Äî agent sam analizuje ekran i daje wskaz√≥wki</p>' +
          '<p>‚Ä¢ <strong>Cron Jobs</strong> ‚Äî automatyczne zadania uruchamiane wg harmonogramu</p>' +
          '<p>‚Ä¢ <strong>Take Control</strong> ‚Äî agent przejmuje myszkƒô/klawiaturƒô (Ctrl+Shift+K)</p>' +
          '<p>‚Ä¢ <strong>RAG</strong> ‚Äî indeksowanie plik√≥w do semantycznego wyszukiwania</p>' +
          '<p>‚Ä¢ <strong>Meeting Coach</strong> ‚Äî nagrywanie spotka≈Ñ z transkrypcjƒÖ i coachingiem</p>' +
          '<p>‚Ä¢ <strong>Dashboard</strong> ‚Äî ta strona! Monitoruj agenta w przeglƒÖdarce.</p>' +
        '</div>' +
      '</div>';
  }

  // Initial load
  handleHash() || loadPage('overview');
})();
</script>
</body>
</html>
